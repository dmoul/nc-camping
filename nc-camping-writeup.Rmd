---
title: "NC Camping Writeup"
author: "Daniel Moul"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_depth: 3
    number_sections: true
    #theme: united
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(here)
source(here("scripts", "my-setup.R"))

```

```{r read-target-objects}
facilities <- tar_read(facilities_all)

federal_org_info <- tar_read(federal_orgs)

nc_history <- tar_read(nc_camping_history) %>%
  mutate(
    facility_name = case_when(
      #str_detect(facility_name, "Cheoah Point Cabin \\d")                                     ~ "Cheoah Point Cabins",
      str_detect(facility_name, "Big Creek Campground \\(Great Smoky Mountains National Park\\)") ~ "Big Creek Campground",
      #str_detect(facility_name, "Cove Creek [Upper|Lower] Group Camp")                        ~ "Cove Creek Group Camp",
      str_detect(facility_name, "Curtis Creek Campground \\(Nc\\)")                           ~ "Curtis Creek Campground",
      TRUE                                                                                    ~ facility_name
    ),
    facility_latitude = if_else(facility_name == "Cape Point Campground", 35.235278, facility_latitude),
    facility_longitude = if_else(facility_name == "Cape Point Campground", -75.535278, facility_longitude),
    year = year(start_date)
  )

year_min <- year_lower_bound
year_max <- max(nc_history$year)

nc_history_dow <- tar_read(nc_camping_history_dow) %>%
  mutate(year = year(start_date))

nc_parks_site_types <- nc_history %>%
  mutate(
      name_first_word = str_extract(facility_name, "\\w+")
  ) %>% 
  # slice_sample(n = 1e5) %>% # for testing
  # This works because each first word is unique--it probably wouldn't work if looking at whole USA
  group_by(name_first_word) %>%
  mutate(facility_id_group = cur_group_id()
  ) %>%
  ungroup() %>%
  group_by(facility_id_group, site_type_simple) %>%
  mutate(n_sites = n_distinct(product_id)) %>%
  ungroup() %>%
  ##distinct(name_first_word, facility_id_group, site_type_simple, .keep_all = TRUE) %>% 
  distinct(facility_id_group, facility_id, site_type_simple, .keep_all = TRUE) %>% 
  select(name_first_word, facility_id, facility_name, facility_type_description, site_type_simple, facility_id_group, n_sites) %>%
  group_by(facility_id_group) %>%
  mutate(facility_name = as.list(facility_name),
         facility_name = glue_collapse(unique(facility_name), sep = " + "),
         facility_id_list = as.list(facility_id),
         facility_id_list = glue_collapse(unique(facility_id_list), sep = ", ")
  ) %>%
  ungroup() %>%
  arrange(facility_name, site_type_simple)
# one row for each facility_name (combined) and site_type_simple
# for cases where only the facility_name ang or facility_group_id matters, use distinct()


nc_parks_site_types_product_id <- nc_history %>%
  tail(10000) %>%
  mutate(
      name_first_word = str_extract(facility_name, "\\w+")
  ) %>% 
  # slice_sample(n = 1e5) %>% # for testing
  group_by(name_first_word) %>%
  mutate(facility_id_group = cur_group_id()
  ) %>%
  ungroup() %>%
  group_by(facility_id_group, site_type_simple) %>%
  mutate(product_id_list = list(unique(product_id)),
         n_sites = length(product_id_list)) %>%
  ungroup() %>%
  ##distinct(name_first_word, facility_id_group, site_type_simple, .keep_all = TRUE) %>% 
  distinct(facility_id_group, facility_id, site_type_simple, .keep_all = TRUE) %>% 
  select(name_first_word, facility_id, facility_name, facility_type_description, site_type_simple, facility_id_group, n_sites) %>%
  group_by(facility_id_group) %>%
  mutate(facility_name = as.list(facility_name),
         facility_name = glue_collapse(unique(facility_name), sep = " + "),
         facility_id_list = as.list(facility_id),
         facility_id_list = glue_collapse(unique(facility_id_list), sep = ", ")
  ) %>%
  ungroup() %>%
  arrange(facility_name, site_type_simple)
# one row for each facility_name (combined) and site_type_simple
# for cases where only the facility_name ang or facility_group_id matters, use distinct()

# nc_parks_site_types_original <- nc_history %>%
#   mutate(
#       name_first_word = str_extract(facility_name, "\\w+")
#   ) %>% 
#   # slice_sample(n = 1e5) %>% # for testing
#   group_by(name_first_word) %>%
#   mutate(facility_id_group = cur_group_id()
#   ) %>%
#   ungroup() %>%
#   #distinct(name_first_word, facility_id_group, site_type_simple, .keep_all = TRUE) %>% 
#   distinct(facility_id_group, facility_id, site_type_simple, .keep_all = TRUE) %>% 
#   select(name_first_word, facility_id, facility_name, facility_type_description, site_type_simple, facility_id_group) %>%
#   group_by(facility_id_group) %>%
#   mutate(facility_name = as.list(facility_name),
#          facility_name = glue_collapse(unique(facility_name), sep = " + "),
#          facility_id_list = as.list(facility_id),
#          facility_id_list = glue_collapse(unique(facility_id_list), sep = ", ")
#   ) %>%
#   ungroup() %>%
#   arrange(facility_name, site_type_simple)
# # one row for each facility_name (combined) and site_type_simple
# # for cases where only the facility_name ang or facility_group_id matters, use distinct()

nc_campsites <- tar_read(nc_campsites_from_history) %>%
  mutate(facility_name = case_when(
    str_detect(facility_name, "Cheoah Point Cabin \\d")                                     ~ "Cheoah Point Cabins",
    str_detect(facility_name, "Big Creek Campground \\(Great Smoky Mountains National Park\\)") ~ "Big Creek Campground",
    str_detect(facility_name, "Cove Creek [Upper|Lower] Group Camp")                        ~ "Cove Creek Group Camp",
    str_detect(facility_name, "Curtis Creek Campground \\(Nc\\)")                           ~ "Curtis Creek Campground",
    TRUE                                                                                    ~ facility_name
  )
  ) %>%
  rename(facility_name_original = facility_name) %>%
  left_join(.,
            nc_parks_site_types %>%
              select(facility_id_group, facility_name, facility_id = facility_id_list) %>%
              separate_rows(facility_id),
            by = "facility_id"
            ) %>%
  distinct(facility_id_group, facility_name, campsite_id)
  
# feather file seems to be flakey, so using rds instead
# park_years <- tar_read(park_years) #%>%
# mutate(facility_state = ifelse(is.na(facility_state), "Not specified", facility_state))
park_years <- readRDS("./data/processed/park-years.rds") %>%
  filter(facility_name != "Washington Monument",
         !is.na(start_year)) %>%
  mutate(
    facility_latitude = if_else(facility_name == "Cape Point Campground", 35.235278, facility_latitude),
    facility_longitude = if_else(facility_name == "Cape Point Campground", -75.535278, facility_longitude)
)
# park_years <- park_years_rds %>%
#   filter(facility_name != "Washington Monument")

nc_yday <- tar_read(nc_camping_history_yday) %>%
  unnest(c(days_of_reservation, yday_of_reservation)) %>%
  count(year, facility_name, site_type_simple, season, days_of_reservation, yday_of_reservation,
        name = "n_campsites") %>%
  arrange(facility_name, year, yday_of_reservation)

nc_week <- tar_read(nc_camping_history_yday) %>%
  unnest(week_of_reservation, yday_of_reservation) %>%
  count(year, facility_name, site_type_simple, season, week_of_reservation, #n_campgrounds, 
        name = "n_campsites") %>%
  arrange(facility_name, year, week_of_reservation, site_type_simple)

nc_week_n_camps_occupied <- tar_read(nc_camping_history_yday) %>%
  filter(year >= year_lower_bound,
         site_type_simple != "management") %>%
  distinct(year, week_of_reservation, facility_name, site_type_simple) %>%
  mutate(week_of_reservation = map(week_of_reservation, unique)) %>%
  unnest(week_of_reservation) %>%
  distinct(year, week_of_reservation, facility_name, site_type_simple) %>%
  group_by(year, week_of_reservation, site_type_simple) %>%
  summarize(n_campgrounds = n_distinct(facility_name)) %>%
  ungroup()

# test
# nc_week_n_camps_occupied %>%
#   mutate(year = factor(year)) %>%
#   ggplot(aes(week_of_reservation, n_campgrounds, color = year)) +
#   geom_line() +
#   facet_grid(site_type_simple ~ ., scales = "free_y")
  

```


<br>

# Introduction

Inspired by Tyler McIntosh's article [The Camping Crunch: Camping's rise in popularity on America's public lands](https://westernpriorities.org/the-camping-crunch/)^[*The Camping Crunch: Camping's rise in popularity on America's public lands* was published Oct 21, 2021 on the website of the Center or Western Priorities at https://westernpriorities.org/the-camping-crunch/ . I found it through a reference in Jeremy Singer-Vines' excellent newsletter *Data is Plural*], I decided to use the same datasets from recreation.gov^[I downloaded datasets from https://ridb.recreation.gov/download on 2021-11-11, specifically (1) overview information in RIDB Recreation Data at https://ridb.recreation.gov/downloads/RIDBFullExport_V1_JSON.zip and (2) historical data for each year FY 2006 - FY 2020 as zipped CSV files, e.g, https://ridb.recreation.gov/downloads/reservations2020.zip for 2020] to look at camping dynamics in North Carolina, where I live.

I wondered, in North Carolina ...

* How many public facilities offer overnight camping?  
* What types of sites do they offer?
* How many are "big" (which I define as having at least `r big_campground_size` campsites)?
* What is the distribution of the number of sites per facility?
* How many camping-nights happen every year, and how has this been changing over time?
* Which parks have become more popular in recent years? Have any become less popular?


<br>

## What's possible given these datasets?

First we have to check: what's in the data, and are there any important limitations? I found three:

1. [recreation.gov](https://recreation.gov/) mostly processes reservations for federal facilities. It does not process reservations for state-owned public campgrounds in North Carolina. NC State Parks use [ReserveAmerica.com](https://ReserveAmerica.com/) instead, thus the campgrounds closest to my home in the [Jordan Lake State Recreation Area](https://www.ncparks.gov/jordan-lake-state-recreation-area/home) and my favorite at [Mount Mitchell](https://www.ncparks.gov/mount-mitchell-state-park/home) are not included in this data set. As noted at https://www.ncparks.gov/find-a-park :

    >There are 41 places that are currently part of the North Carolina State Parks system: 34 parks, four recreation areas, and three staffed state natural areas.

<br>

2. As is visible in the per-campground trend data starting with [camping person-nights by park], there are a lot of outliers in the data in 2018, 2019, and 2020. Likely there are two causes: 
    - Data for 2018 and 2019 data are less reliable than other years as explained in the 2018 history readme:

    >Due to the transition between Rec.gov vendors the FY 2018 historical reservation data has not been fully verified for accuracy and completeness.

    - In 2020 due the the COVID-19 pandemic, people changed their behavior significantly, and camping facilities were closed for some periods of the year. For example, I can imagine that group campsites would be used less frequently, and group size would be much smaller than earlier years.

<br>

3. Some campsites are not reservable at all. Some may not be reservable in the off season, so by definition, use of these sites will not show up in this data set.


```{r}
fy2020_summary <- nc_history %>%
  filter(year == 2020) %>%
  summarize(person_nights = sum(person_nights),
            revenue = sum(total_paid))

```

<br>

## Our focus is federally-owned facilities in NC

So setting aside the NC State Park system, we will focus here on federal facilities in NC, which in 2020 provided `r comma(fy2020_summary$person_nights)` person-nights of camping and collected `r dollar(fy2020_summary$revenue)` in overnight camping fees. 

I will refer to the facilities as campgrounds and campsites even though some are cabins, lodges or shelters.

# Federal agencies, camping facilities and campsites

The following federal agencies offer overnight camping with reservations via recreation.gov:

<br>

```{r}
nc_history %>%
  left_join(.,
            federal_org_info,
            by = c("parent_org_id" = "org_id")
  ) %>%
  distinct(facility_id, .keep_all = TRUE) %>%
  #distinct(parent_org_id, .keep_all = TRUE) %>%
  count(org_name, org_abbrev_name, org_url_address,
        name = "n_facilities") %>% #, facility_name, name = "n_reservations") %>%
  select(org_name, n_facilities, org_abb = org_abbrev_name, org_url = org_url_address) %>% #, facility_name, n_reservations)
  arrange(-n_facilities) %>%
  gt() %>%
  tab_header(md(glue("***Federal agencies offering overnight camping reservations***",
                     "<br>via recreation.gov in NC")))

```

<br><br>

Specifically the data set include the following facilities, which provided nearly 7 million person-nights of camping 2009-2020.

Some notes:

* A `person_night` is one person camping one night. So if four people camp on a Friday and Saturday night, that's 8 person_nights.
* For most facilities, the data set includes separate `feature_id` values for each site_type offered. Some have slightly different names, for example, I have combined *Cataloochee Group Camp + Cataloochee Horse Camp + Cataloochee Campground* into one `facility_name` with a common `facility_id_group`.
* For each `facility_id_group`, `n_sites` is a count of distinct `product_id` values. I am assuming that `product_id` values have not changed over time and the same value is not used for multiple campsites at the same facility.

<br>

```{r}
# TODO: Fix duplicates & missings. Join is not working as expected.

# there is some reuse of product_id across site_type_simple at single facility_ids, and maybe across facility_ids.
# so need to group_by(facility_id, site_type_simple) before n_distinct(product_id)
# xx <- nc_history %>%
#   filter(year(start_date) >= year_lower_bound) %>%
#   group_by(facility_id, site_type_simple) %>%
#   summarize(n_sites = n_distinct(product_id)) %>%
#   ungroup() %>%
#   pull(n_sites) %>%
#   sum()

orgs_for_table <- nc_history %>%
  filter(year >= year_lower_bound) %>%
  mutate(name_first_word = str_extract(facility_name, "\\w+")) %>%
  rename(facilility_name_original = facility_name) %>%
  inner_join(.,
             nc_parks_site_types %>% 
               # group_by(facility_id_group, facility_name, site_type_simple) %>%
               # summarize(n_sites_by_type = sum(n_sites)) %>%
               # ungroup() %>%
               mutate(name_first_word = str_extract(facility_name, "\\w+")) %>%
               group_by(name_first_word, facility_id_group, facility_name, site_type_simple) %>%
               summarize(n_sites = sum(n_sites)) %>% #n_sites_by_type
               ungroup(),
             by = c("name_first_word", "site_type_simple")) %>% #, "site_type_simple"
  group_by(facility_id_group, facility_name, site_type_simple) %>% #site_type_simple, 
  summarize(n_sites = unique(n_sites),
            person_nights = sum(person_nights),
            n_years = n_distinct(year),
            avg_yearly_person_nights = person_nights / n_years) %>%
  ungroup() %>%
  group_by(facility_id_group, facility_name,) %>% #site_type_simple, 
  summarize(n_sites = sum(n_sites),
            person_nights = sum(person_nights),
            n_years = unique(n_years),
            avg_yearly_person_nights = person_nights / n_years) %>%
  ungroup() %>%
  arrange(-n_years) %>%
  distinct(facility_id_group, .keep_all = TRUE) %>%
  arrange(facility_id_group) %>%
  relocate(n_years, .after = avg_yearly_person_nights)

# TODO: delete this
#max_year <- max(year(nc_history$start_date)) # use year_max instead     
                
orgs_for_table %>%
  #arrange(-avg_yearly_person_nights) %>%
  adorn_totals(., where = "row", fill = NA, na.rm = TRUE, name = "Total", starts_with(c("n_sites", "person_nights"))) %>%
  gt() %>%
  tab_header(md(glue("***Facilities in NC offering overnight camping reservations", 
                     "<br>And person-nights of camping 2009-2020***",
                     "<br>via recreation.gov"))) %>%
  cols_align(columns = "facility_name", align = "left") %>%
  fmt_number(columns = n_sites:avg_yearly_person_nights,
             decimals = 0) %>%
  fmt_missing(columns = everything()) %>%
  tab_footnote(md(glue("*Sum of all person-nights of reserved camping", 
                       " with start date in {year_lower_bound} through {year_max} via recreation.gov*")),
               locations = cells_column_labels(columns = person_nights)) %>%
  tab_footnote(md(glue("*Since the number of person-nights has been increasing year-over-year", 
                       " the average under-respresents recent activity at campgrounds with the most years of data*")),
               locations = cells_column_labels(columns = avg_yearly_person_nights))

```

<br><br>

There are `r nrow(distinct(nc_parks_site_types, facility_id_group))` federal facilities in North Carolina offering reservations through recreation.gov, which I consolidated from `r nrow(distinct(nc_history, facility_id)) ` separate `facility_id` values, since some parks separate cabins or group campgrounds as separate facilities.

In the table below, where there is a `1` in the cell, the facility offers this `site_type`.

<br>

```{r nc-parks-site-types-for-table}
# nc_parks_site_types_for_table <- nc_parks_site_types %>%
#   #mutate(temp = 1) %>% # a "1" in a cell means "this park has this site type
#   pivot_wider(names_from = site_type_simple, values_from = n_sites) %>%
#   mutate(across(c(standard, tent, cabin, group, equestrian, rv, management), ~replace_na(.x, 0))) %>%
#   group_by(facility_id_group, facility_name, facility_id_list) %>%
#   #summarize(across(c(standard, tent, cabin, group, equestrian, rv, management), sum)) %>%
#   summarize(across(c(standard, tent, cabin, group, equestrian, rv, management), ~ifelse(any(.x > 0), .x, NA_real_))) %>%
#   ungroup() %>%
#   # distinct(facility_id_group, .keep_all = TRUE) %>%
#   mutate(#row = row_number(),
#          across(where(is.numeric), ~na_if(.x, 0))
#          ) %>%
#   adorn_totals(where = "col", name = "n_sites") %>%
#   adorn_totals(where = "row", name = "Total inventory")

# this works, but trying another method to accomodate even more reuse of product_id values
# nc_parks_site_types_for_table <- nc_history %>%
#   filter(year(start_date) >= year_lower_bound) %>%
#   mutate(name_first_word = str_extract(facility_name, "\\w+")) %>%
#   rename(facilility_name_original = facility_name) %>%
#   inner_join(.,
#              nc_parks_site_types %>% 
#                distinct(facility_id_group, facility_name, facility_id_list, site_type_simple) %>%
#                mutate(name_first_word = str_extract(facility_name, "\\w+")),
#              by = c("name_first_word", "site_type_simple")) %>%
#   group_by(facility_id_group, facility_name, facility_id_list, site_type_simple) %>%
#   summarize(n_sites = n_distinct(product_id)) %>%
#   ungroup() %>%
#   pivot_wider(names_from = site_type_simple, values_from = n_sites) %>%
#   mutate(across(c(standard, tent, cabin, group, equestrian, rv, management), ~replace_na(.x, 0))) %>%
#   group_by(facility_id_group, facility_name, facility_id_list) %>%
#   #summarize(across(c(standard, tent, cabin, group, equestrian, rv, management), sum)) %>%
#   summarize(across(c(standard, tent, cabin, group, equestrian, rv, management), ~ifelse(any(.x > 0), .x, NA_real_))) %>%
#   ungroup() %>%
#   # distinct(facility_id_group, .keep_all = TRUE) %>%
#   mutate(#row = row_number(),
#          across(where(is.numeric), ~na_if(.x, 0))
#          ) %>%
#   adorn_totals(where = "col", name = "n_sites") %>%
#   adorn_totals(where = "row", name = "Total inventory")


nc_parks_site_types_for_table <- nc_history %>%
  filter(year >= year_lower_bound) %>%
  mutate(name_first_word = str_extract(facility_name, "\\w+")) %>%
  rename(facilility_name_original = facility_name) %>%
  inner_join(.,
             nc_parks_site_types %>% 
               #distinct(facility_id_group, facility_name, facility_id_list, site_type_simple) %>%
               mutate(name_first_word = str_extract(facility_name, "\\w+")) %>%
               group_by(name_first_word, facility_id_group, facility_id_list, facility_name, site_type_simple) %>%
               summarize(n_sites = sum(n_sites)) %>%
               ungroup(),
             by = c("name_first_word", "site_type_simple")) %>%
  group_by(facility_id_group, facility_name, facility_id_list, site_type_simple) %>%
  summarize(n_sites = n_distinct(product_id)) %>%
  ungroup() %>%
  pivot_wider(names_from = site_type_simple, values_from = n_sites) %>%
  mutate(across(c(standard, tent, cabin, group, equestrian, rv, management), ~replace_na(.x, 0))) %>%
  group_by(facility_id_group, facility_name, facility_id_list) %>%
  #summarize(across(c(standard, tent, cabin, group, equestrian, rv, management), sum)) %>%
  summarize(across(c(standard, tent, cabin, group, equestrian, rv, management), ~ifelse(any(.x > 0), .x, NA_real_))) %>%
  ungroup() %>%
  # distinct(facility_id_group, .keep_all = TRUE) %>%
  mutate(#row = row_number(),
         across(where(is.numeric), ~na_if(.x, 0))
         ) %>%
  adorn_totals(where = "col", name = "n_sites") %>%
  adorn_totals(where = "row", name = "Total inventory")

  

# nc_parks_site_types_for_table[nrow(nc_parks_site_types_for_table), ncol(nc_parks_site_types_for_table)] <- NA

nc_parks_site_types_for_table %>%
  gt() %>%
  tab_header(md(glue("**Site types offered by federal camping facilities in NC**",
                     ""))) %>%
  tab_spanner(
    label = "Site type",
    columns = standard:management
  ) %>%
  cols_align(columns = standard:management,
             align = "center") %>%
  fmt_number(columns = standard:n_sites,
             decimals = 0) %>%
  fmt_missing(columns = everything(), 
              missing_text = "")
  
```

<br><br>

```{r}
# finding the missing 27 sites

anomalies <- nc_history %>%
  filter(year >= year_lower_bound) %>%
  mutate(name_first_word = str_extract(facility_name, "\\w+")) %>%
  rename(facilility_name_original = facility_name) %>%
  filter(name_first_word %in% c("Cheoah", "Cove", "Julian", "Lake"))
  
# top table creates 27 more
tbl1 <- anomalies %>%
 inner_join(.,
             nc_parks_site_types %>% 
               # group_by(facility_id_group, facility_name, site_type_simple) %>%
               # summarize(n_sites_by_type = sum(n_sites)) %>%
               # ungroup() %>%
               mutate(name_first_word = str_extract(facility_name, "\\w+")) %>%
               group_by(name_first_word, facility_id_group, facility_name, site_type_simple) %>%
               summarize(n_sites = sum(n_sites)) %>% #n_sites_by_type
               ungroup(),
             by = c("name_first_word", "site_type_simple")) %>% #, "site_type_simple"
  group_by(facility_id_group, facility_name, site_type_simple) %>% #site_type_simple, 
  summarize(n_sites = unique(n_sites),
            person_nights = sum(person_nights),
            n_years = n_distinct(year),
            avg_yearly_person_nights = person_nights / n_years) %>%
  ungroup() %>%
  group_by(facility_id_group, facility_name,) %>% #site_type_simple, 
  summarize(n_sites = sum(n_sites),
            person_nights = sum(person_nights),
            n_years = unique(n_years),
            avg_yearly_person_nights = person_nights / n_years) %>%
  ungroup() %>%
  arrange(-n_years) %>%
  distinct(facility_id_group, .keep_all = TRUE) %>%
  arrange(facility_id_group) %>%
  relocate(n_years, .after = avg_yearly_person_nights)
 
 # second table creates 27 less
tbl2 <- anomalies %>%
  inner_join(.,
             nc_parks_site_types %>% 
               #distinct(facility_id_group, facility_name, facility_id_list, site_type_simple) %>%
               mutate(name_first_word = str_extract(facility_name, "\\w+")) %>%
               group_by(name_first_word, facility_id_group, facility_id_list, facility_name, site_type_simple) %>%
               summarize(n_sites = sum(n_sites)) %>%
               ungroup(),
             by = c("name_first_word", "site_type_simple")) %>%
  group_by(facility_id_group, facility_name, facility_id_list, site_type_simple) %>%
  summarize(n_sites = n_distinct(product_id)) %>%
  ungroup() %>%
  pivot_wider(names_from = site_type_simple, values_from = n_sites) %>%
  #mutate(across(c(standard, tent, cabin, group, equestrian, rv, management), ~replace_na(.x, 0))) %>%
  mutate(across(standard:management, ~replace_na(.x, 0))) %>%
  group_by(facility_id_group, facility_name, facility_id_list) %>%
  #summarize(across(c(standard, tent, cabin, group, equestrian, rv, management), sum)) %>%
  summarize(across(standard:management, ~ifelse(any(.x > 0), .x, NA_real_))) %>%
  ungroup() %>%
  # distinct(facility_id_group, .keep_all = TRUE) %>%
  mutate(#row = row_number(),
         across(where(is.numeric), ~na_if(.x, 0))
         ) %>%
  adorn_totals(where = "col", name = "n_sites") %>%
  adorn_totals(where = "row", name = "Total inventory")
  
  
```


***TODO: Why is above total 2892 different from "2.3 Sites per campground in NC" total "46 campgrounds offer 3,294 sites"***

```{r nc-parks-site-types-for-table-orginal, eval=FALSE}
nc_parks_site_types_for_table <- nc_parks_site_types %>%
  mutate(temp = 1) %>% # a "1" in a cell means "this park has this site type
  pivot_wider(names_from = site_type_simple, values_from = temp ) %>%
  mutate(across(c(standard, tent, cabin, group, equestrian, rv, management), ~replace_na(.x, 0))) %>%
  group_by(facility_id_group, facility_name, facility_id_list) %>%
  #summarize(across(c(standard, tent, cabin, group, equestrian, rv, management), sum)) %>%
  summarize(across(c(standard, tent, cabin, group, equestrian, rv, management), ~ifelse(any(.x > 0), 1, NA_real_))) %>%
  ungroup() %>%
  # distinct(facility_id_group, .keep_all = TRUE) %>%
  mutate(#row = row_number(),
         across(where(is.numeric), ~na_if(.x, 0))
         ) %>%
  adorn_totals(where = "row") %>%
  adorn_totals(where = "col", name = "n_site_types")

nc_parks_site_types_for_table[nrow(nc_parks_site_types_for_table), ncol(nc_parks_site_types_for_table)] <- NA

nc_parks_site_types_for_table %>%
  gt() %>%
  tab_header(md(glue("**Site types offered by federal camping facilities in NC**",
                     ""))) %>%
  tab_spanner(
    label = "Site type",
    columns = standard:management
  ) %>%
  cols_align(columns = standard:management,
             align = "center") %>%
  fmt_missing(columns = everything(), 
              missing_text = "")
  
```

About half of the campgrounds have at least 50 campsites:

```{r out.width="100%", fig.width=6}
nc_campsites %>%
  count(facility_id_group, facility_name, name = "n_sites") %>%
  ggplot(aes(n_sites)) +
  stat_ecdf(size = 2, color = "firebrick") +
  scale_y_continuous(labels = percent_format()) +
  labs(title = glue("Percent of all {nrow(distinct(nc_parks_site_types, facility_id_group))}", 
                    " NC campgrounds \nwith at least n_site campsites"),
       y = "")
```

<br>

# Park locations

Parks are nearly all in the mountains in the West or at coast in the East.

```{r}
nc_parks_for_map <- park_years %>%
  #mutate(facility_name = str_remove(facility_name, " Campground.*$")) %>%
  mutate(facility_name = str_remove(facility_name, " Camp(.*$)?")) %>%
  filter(facility_state == "NC") %>%
  distinct(facility_id, facility_longitude, facility_latitude, .keep_all = TRUE) %>%
  st_as_sf(coords = c("facility_longitude", "facility_latitude")) %>%
  st_set_crs("NAD83") #"EPSG:32119") # NAD83 for NC

nc_counties <- tigris::counties(state = "37",  # NC
                                cb = TRUE # download generalized 500K file
                                )

```

```{r out.width="100%", fig.width=6}
ggplot() + 
  geom_sf(data = nc_counties, color = "grey50", size = 0.1, fill = "tan", alpha = 0.2) + 
  geom_sf(data = nc_parks_for_map, 
          aes(color = agency),
          alpha = 0.5) +
  geom_sf_text(data = nc_parks_for_map %>% st_crop(xmin = -180, xmax = -78, ymin = -90, ymax = 90),
               aes(label = facility_name, color = agency),
               check_overlap = TRUE,
               vjust = 0.5, 
               hjust = 0, nudge_x = 0.075,
               size = 2,
               show.legend = FALSE) +
  geom_sf_text(data = nc_parks_for_map %>% st_crop(xmin = -78, xmax = 0, ymin = -90, ymax = 90),
               aes(label = facility_name, color = agency),
               check_overlap = TRUE,
               vjust = 0.5, 
               hjust = 1, nudge_x = -0.075,
               size = 2,
               show.legend = FALSE) +
  theme_map() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        legend.position = "top",
        legend.justification = "center") +
  labs(title = "NC public facilities with overnight reservations",
       subtitle = glue("at recreation.gov {year_lower_bound} - 2020"),
       color = "Agency:"
  )
```

<br>

## Person-nights and revenue per park

```{r}
nc_camping_person_nights_and_revenue <- nc_history %>%
  mutate(facility_first_word = str_extract(facility_name, "\\w+")) %>%
  rename(facility_name_original = facility_name) %>%
  inner_join(.,
             nc_parks_site_types %>% 
               select(facility_id_group, facility_name, facility_id_list) %>%
               mutate(facility_first_word = str_extract(facility_name, "\\w+")),
             by = "facility_first_word") %>%
  #filter(str_detect(site_type, "STANDARD") & !str_detect(site_type, "GROUP")) %>%
  filter(!str_detect(site_type, "management")) %>%
  # mutate(#year = as.numeric(str_extract(path, "\\d+"))
  #   year = year(start_date)
  #        ) %>%
  group_by(year, facility_name) %>%
  summarize(n = n(), 
            revenue_in_year = sum(total_paid, na.rm = TRUE),
            person_nights = sum(person_nights)
            ) %>%
  ungroup()
```

<br>

Number of yearly camping-nights has been increasing in most parks:

```{r nc-park-person-nights, fig.height=16, fig.width=16}
facility_name_levels_person_nights <- nc_camping_person_nights_and_revenue %>%
  group_by(facility_name) %>%
  filter(person_nights == max(person_nights),
         n > 1) %>%
  ungroup() %>%
  distinct(facility_name, person_nights) %>%
  arrange(desc(person_nights)) %>%
  pull(facility_name)

nc_person_nights_for_plot <- nc_camping_person_nights_and_revenue %>%
  filter(!str_detect(facility_name, "picnic"),
        n > 1) %>%
  mutate(facility_name = factor(facility_name, levels = facility_name_levels_person_nights)) %>%
  arrange(as.integer(facility_name))

park_names_midpoint <- floor(max(as.integer(nc_person_nights_for_plot$facility_name)) / 2)
facilities_part1 <- tibble(facility_name = facility_name_levels_person_nights[1:park_names_midpoint])
facilities_part2 <- tibble(facility_name = facility_name_levels_person_nights[(park_names_midpoint + 1):length(facility_name_levels_person_nights)])

part1_person_nights <- nc_person_nights_for_plot %>%
  mutate(facility_name = as.character(facility_name)) %>%
  inner_join(., facilities_part1 %>%
               mutate(facility_name = as.character(facility_name)), 
             by = "facility_name") %>%
   mutate(facility_name = factor(facility_name, levels = facility_name_levels_person_nights))

part2_person_nights <- nc_person_nights_for_plot %>%
  mutate(facility_name = as.character(facility_name)) %>%
  inner_join(., facilities_part2 %>%
               mutate(facility_name = as.character(facility_name)),
             by = "facility_name") %>%
   mutate(facility_name = factor(facility_name, levels = facility_name_levels_person_nights))

plot_nc_camping_person_nights <- function(tbl) {
  tbl %>%
  ggplot(aes(year, person_nights)) +
  #geom_line(color = "firebrick") +
  geom_smooth(se = FALSE, span = 0.95,) +
  geom_point(size = 2, color = "firebrick") +
  scale_x_continuous(breaks = seq(2005, 2020, by = 5), labels = label_number(accuracy = 1)) +
  scale_y_continuous(labels = label_number_si()) +
  scale_color_viridis_d(end = 0.92) +
  guides(color = guide_legend(reverse = TRUE)) +
  expand_limits(y = 0) +
  facet_wrap(~ facility_name, ncol = 6, scales = "free_y", labeller = label_wrap_gen(width=20)) +
  labs(title = "NC person-nights camping per year by campground",
       subtitle = "Y axis varies. Subplots ordered by decending maximum yearly person-nights",
       x = "",
       y = "")
}

p1 <- plot_nc_camping_person_nights(part1_person_nights)

ggsave(here("figures", "nc_camping_person_nights_by_campsite_part1.png"),
       height = 16, width = 16,
       dpi = 300)

p2 <- plot_nc_camping_person_nights(part2_person_nights)

ggsave(here("figures", "nc_camping_person_nights_by_campsite_part2.png"),
       height = 16, width = 16,
       dpi = 300)

```

```{r nc-park-revenue, fig.height=16, fig.width=16}
facility_name_levels_revenue <- nc_camping_person_nights_and_revenue %>%
  group_by(facility_name) %>%
  filter(revenue_in_year == max(revenue_in_year),
         n > 1) %>%
  ungroup() %>%
  distinct(facility_name, revenue_in_year) %>%
  arrange(desc(revenue_in_year)) %>%
  pull(facility_name)

nc_revenue_for_plot <- nc_camping_person_nights_and_revenue %>%
  filter(!str_detect(facility_name, "picnic"),
         n > 1) %>%
  mutate(facility_name = factor(facility_name, levels = facility_name_levels_revenue)) %>%
  arrange(as.integer(facility_name))

park_names_midpoint <- floor(max(as.integer(nc_person_nights_for_plot$facility_name)) / 2)
facilities_part1 <- tibble(facility_name = facility_name_levels_revenue[1:park_names_midpoint])
facilities_part2 <- tibble(facility_name = facility_name_levels_revenue[(park_names_midpoint + 1):length(facility_name_levels_revenue)])

part1_revenue <- nc_revenue_for_plot %>%
  mutate(facility_name = as.character(facility_name)) %>%
  inner_join(., facilities_part1 %>%
               mutate(facility_name = as.character(facility_name)),
             by = "facility_name") %>%
   mutate(facility_name = factor(facility_name, levels = facility_name_levels_revenue))

part2_revenue <- nc_revenue_for_plot %>%
  mutate(facility_name = as.character(facility_name)) %>%
  inner_join(., facilities_part2 %>%
               mutate(facility_name = as.character(facility_name)),
             by = "facility_name") %>%
   mutate(facility_name = factor(facility_name, levels = facility_name_levels_revenue))
  
plot_nc_camping_revenue <- function(tbl) {
  tbl %>%
  ggplot(aes(year, revenue_in_year)) +
  geom_smooth(se = FALSE, span = 0.95,) +
  geom_point(size = 2, color = "firebrick") +
  scale_x_continuous(breaks = seq(2005, 2020, by = 5), labels = label_number(accuracy = 1)) +
  scale_y_continuous(labels = dollar_format(scale = 1/1000, suffix = "K")) +
  scale_color_viridis_d(end = 0.92) +
  guides(color = guide_legend(reverse = TRUE)) +
  expand_limits(y = 0) +
  facet_wrap(~ facility_name, ncol = 6, scales = "free_y", labeller = label_wrap_gen(width=20)) +
  labs(title = "NC camping revenue per year by campground",
       subtitle = "Y axis varies. Subplots ordered by decending maximum yearly camping revenue",
       x = "",
       y = "")
}

p3 <- plot_nc_camping_revenue(part1_revenue)

ggsave(here("figures", "nc_camping_revenue_by_campsite_part1.png"),
       height = 16, width = 16,
       dpi = 300)

p4 <- plot_nc_camping_revenue(part2_revenue)

ggsave(here("figures", "nc_camping_revenue_by_campsite_part2.png"),
       height = 16, width = 16,
       dpi = 300)

```

### Camping person-nights by park

Part 1:

![NC camping person-nights per year by campground (part 1)](`r here("figures", "nc_camping_person_nights_by_campsite_part1.png")`)

<br> 
Part 2:

![NC camping person-nights per year by campground (part 2)](`r here("figures", "nc_camping_person_nights_by_campsite_part2.png")`)

<br>

### Camping revenue by park

Part 1:

![NC camping revenue per year by campground (part 1)](`r here("figures", "nc_camping_revenue_by_campsite_part1.png")`)

<br> 
Part 2:

![NC camping revenue per year by campground (part 2)](`r here("figures", "nc_camping_revenue_by_campsite_part2.png")`)

<br>

## Are the increases occurring during a particular time of the year?

Defining the summer season to be the four months `r month(summer_season_start, label = TRUE)` `r day(summer_season_end)` to `r month(summer_season_end, label = TRUE)` `r day(summer_season_end)`, we see most camps are busiest during the summer. And while the number of camping person-nights has increased year-round, for most campgrounds, more of the growth has been during the summer:

```{r}
nc_camping_seasons <- nc_history %>%
  mutate(facility_first_word = str_extract(facility_name, "\\w+")) %>%
  rename(facility_name_original = facility_name) %>%
  inner_join(.,
             nc_parks_site_types %>% 
               select(facility_id_group, facility_name, facility_id_list) %>%
               mutate(facility_first_word = str_extract(facility_name, "\\w+")),
             by = "facility_first_word") %>%
  filter(!str_detect(site_type, "management")) %>%
  mutate(
    month = month(start_date),
    season = if_else(between(yday(start_date), yday(summer_season_start), yday(summer_season_end)),
                     "summer",
                     "off-season"
                     )
    ) %>%
  group_by(facility_name, year, season) %>%
  summarize(n = n(), 
            revenue_in_year = sum(total_paid, na.rm = TRUE),
            person_nights = sum(person_nights)
            ) %>%
  ungroup()
```

```{r nc-park-person-nights-seaonality}
facility_name_levels_person_nights <- nc_camping_seasons %>%
  group_by(facility_name) %>%
  filter(person_nights == max(person_nights),
         n > 1) %>%
  ungroup() %>%
  distinct(facility_name, person_nights) %>%
  arrange(desc(person_nights)) %>%
  pull(facility_name)

nc_person_nights_for_plot <- nc_camping_seasons %>%
  filter(!str_detect(facility_name, "picnic"),
        n > 1) %>%
  mutate(facility_name = factor(facility_name, levels = facility_name_levels_person_nights)) %>%
  arrange(as.integer(facility_name))

park_names_midpoint <- floor(max(as.integer(nc_person_nights_for_plot$facility_name)) / 2)
facilities_part1 <- tibble(facility_name = facility_name_levels_person_nights[1:park_names_midpoint])
facilities_part2 <- tibble(facility_name = facility_name_levels_person_nights[(park_names_midpoint + 1):length(facility_name_levels_person_nights)])

part1_person_nights <- nc_person_nights_for_plot %>%
  mutate(facility_name = as.character(facility_name)) %>%
  inner_join(., facilities_part1 %>%
               mutate(facility_name = as.character(facility_name)),
             by = "facility_name") %>%
   mutate(facility_name = factor(facility_name, levels = facility_name_levels_person_nights))

part2_person_nights <- nc_person_nights_for_plot %>%
  mutate(facility_name = as.character(facility_name)) %>%
  inner_join(., facilities_part2 %>%
               mutate(facility_name = as.character(facility_name)),
             by = "facility_name") %>%
   mutate(facility_name = factor(facility_name, levels = facility_name_levels_person_nights))

plot_nc_season_person_nights <- function(tbl) {
  tbl %>%
  ggplot(aes(year, person_nights, color = season)) +
  #geom_line(color = "firebrick") +
  geom_smooth(se = FALSE, span = 0.95,) +
  geom_point(size = 2) + #, color = "firebrick") +
  scale_x_continuous(breaks = seq(2005, 2020, by = 5), labels = label_number(accuracy = 1)) +
  scale_y_continuous(labels = label_number_si()) +
  scale_color_viridis_d(end = 0.92) +
  guides(color = guide_legend(reverse = TRUE)) +
  expand_limits(y = 0) +
  facet_wrap(~ facility_name, ncol = 6, scales = "free_y", labeller = label_wrap_gen(width=20)) +
  labs(title = "NC person-nights camping per year by campground",
       subtitle = "Y axis varies. Subplots ordered by decending maximum yearly person-nights",
       x = "",
       y = "")
}

p5 <- plot_nc_season_person_nights(part1_person_nights)

ggsave(here("figures", "nc_season_camping_person_nights_by_campsite_part1.png"),
       height = 16, width = 16,
       dpi = 300)

p6 <- plot_nc_season_person_nights(part2_person_nights)

ggsave(here("figures", "nc_season_camping_person_nights_by_campsite_part2.png"),
       height = 16, width = 16,
       dpi = 300)

```

Part 1:

![NC seasonal camping person-nights per year by campground (part 1)](`r here("figures", "nc_season_camping_person_nights_by_campsite_part1.png")`)

<br> 
Part 2:

![NC seasonal camping person-nights per year by campground (part 2)](`r here("figures", "nc_season_camping_person_nights_by_campsite_part2.png")`)

<br>

## Are there trends by week of the year?

```{r year-week-occupancy, fig.height=6}
nc_week_max <- nc_week %>%
  group_by(facility_name, site_type_simple) %>%
  slice_max(n = 1, order_by = n_campsites, with_ties = FALSE) %>%
  ungroup() %>%
  arrange(facility_name, week_of_reservation, site_type_simple)

nc_week_occupancy <- nc_week %>%
  left_join(.,
            nc_week_max %>% 
              select(facility_name, site_type_simple, n_campsites_max = n_campsites),
            by = c("facility_name", "site_type_simple")) %>%
  mutate(occupancy = n_campsites / n_campsites_max) %>%
  arrange(facility_name, year, week_of_reservation, site_type_simple)

# TODO: above isn't accurate yet?
# TODO: Should I weight average occupancy by the number of campsites at each campground?
# Done: How do I want to define weekly occupancy: portion of max_sites * 7 reserved during week? count of person-nights reserved during week, max campsites reserved during week? Best: max of occupancy during the week

```

Some observations

* Autumn is a very popular time to camp--more than the spring.
* There aren't many campgrounds offering overnight reservations during the winter months.
* The 2019 and 2020 data seem suspect, especially for group sites.
* In 2020 it looks like most facilities were closed at the end of September.


```{r fig.height=9, fig.width=9, out.width="100%"}
nc_week_occupancy %>%
  filter(year >= year_lower_bound,
         site_type_simple != "management") %>%
  group_by(year, site_type_simple, week_of_reservation) %>% #season, 
  summarize(occupancy = max(occupancy)) %>%
  ungroup() %>%
  left_join(.,
            nc_week_n_camps_occupied,
            by = c("year", "week_of_reservation", "site_type_simple")) %>%
  mutate(year = factor(year)) %>%
  ggplot(aes(week_of_reservation, occupancy, color = year, group = year, size = n_campgrounds)) +
  geom_vline(xintercept = c(week(ymd(summer_season_start)), week(ymd(summer_season_end))), 
             lty = 2, color = "firebrick", alpha = 0.5) +
  geom_vline(xintercept = week(ymd("2020-07-04")), 
             lty = 2, color = "blue", alpha = 0.5) +
  geom_line(alpha = 0.6) + 
  #geom_point(alpha = 0.6, show.legend = FALSE) + 
  scale_y_continuous(labels = percent_format()) +
  scale_size_continuous(range = c(0.25, 2), breaks = c(1, 10, 20, 30)) + #,guide = 'none') +
  scale_color_viridis_d(end = 0.92) +
  #facet_grid(site_type_simple ~ .) +
  facet_wrap(~ site_type_simple, ncol = 2) +
  theme(panel.grid.major.x = element_blank()) +
  guides(color = guide_legend(reverse = TRUE, override.aes = list(size = 3))) +
  labs(title = "NC camping occupancy rate by week",
       subtitle = glue("Red vertical lines indicate summer season (start: {summer_season_start}, end: {summer_season_end})",
                       "\nBlue line is week including July 4th"),
       x = "week of the year",
       y = "occupancy (% of max occupancy across NC)",
       color = "Year",
       size = "Number of\ncampgrounds")

```


<br>

## Are there trends by day of the week?

```{r}

nc_history_dow %>%
  filter(year >= year_lower_bound) %>%
  count(season, dow = all_days_string) %>%
  mutate(dow = factor(dow, levels = dow_labels),
         dow_scaled = n / max(n)) %>%
  ggplot(aes(dow, n, fill = season)) + #dow_scaled)) +
  geom_col() + 
  scale_y_continuous(
    labels = label_number_si(),
    sec.axis = sec_axis(trans = ~ .x / max(.x),
                        labels = percent_format(),
                        name = "Percentage of largest")
  ) +
  scale_fill_viridis_d(end = 0.92) +
  theme(panel.grid.major.x = element_blank()) +
  labs(title = "NC camping each night of the week",
       subtitle = glue("Midweek is about half as busy as on the weekend",
                       "\nAll nights {year_min}-{year_max}"),
       x = "",
       y = "person-nights")

```


<br>

The increasing yearly number of person-nights occurred for all nights. The most noticeable anomaly is extra Sunday, Monday and Tuesday night camping in 2020. Presumably this was due to the pandemic shutdown, perhaps because people had fewer recreational options than other years. The unusually low off-season 2020 numbers probably reflect camp closures.

```{r fig.height=6}
nc_history_dow %>%
  filter(year >= year_lower_bound) %>%
  count(year, season, dow = all_days_string) %>%
  mutate(year = factor(year),
         dow = factor(dow, levels = dow_labels),
         dow_scaled = n / max(n)) %>%
  ggplot(aes(dow, n, color = year, group = year)) + 
  geom_line() + 
  geom_point() + 
  scale_y_continuous(
    labels = label_number_si(),
    sec.axis = sec_axis(trans = ~ .x / max(.x),
                        labels = percent_format(),
                        name = "Percentage of largest")
  ) +
  scale_color_viridis_d(end = 0.92) +
  facet_wrap(~ season) +
  theme(panel.grid.major.x = element_blank()) +
  guides(color = guide_legend(reverse = TRUE)) +
  labs(title = "NC camping each night of the week (person-nights)",
       subtitle = glue("Midweek is about half as busy as on the weekend {year_min}-{year_max}"),
       x = "")

```

<br>

```{r polar-dow, fig.height=4, eval=FALSE}
# fig.height=6

#dow_labels_mon_start = c("Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun")

nc_history_dow %>%
  filter(#season == "summer",
    year >= 2008) %>%
  count(year, season, dow = all_days_string) %>%
  mutate(#year = factor(year),
         dow = factor(dow, levels = dow_labels),
         dow_scaled = n / max(n)) %>%
  arrange(season, year, dow) %>%
  group_by(season) %>%
  mutate(id = row_number() %% 7) %>%
  ungroup() %>%
  #ggplot(aes(id %% 7, n, group = year)) + #, color = year
  #ggplot(aes(as.integer(year), n, color = year, group = year)) + #
  ggplot(aes(id, n, color = year, group = year)) + #
  geom_line() + 
  geom_point() + 
  scale_x_continuous(expand = c(0,0),
                     labels = dow_labels,
                   oob = scales::oob_keep) +
  scale_y_continuous(
    labels = label_number_si() #,
    # sec.axis = sec_axis(trans = ~ .x / max(.x),
    #                     labels = percent_format(),
    #                     name = "Percentage of largest")
  ) +
  scale_fill_viridis_d(end = 0.92) +
  facet_grid(~season) +
  coord_polar(theta = "x") +
  #theme(panel.grid.major.x = element_blank()) +
  labs(title = "NC camping each night of the week (person-nights)",
       subtitle = "Midweek is about half as busy as on the weekend",
       x = "")
  
# TODO: separate Sat from Sun and bridge them (is it worth the effort?)
```

<br>

## How far ahead do you need to reserve?

As you might expect, sites in limited supply are booked earlier: more than a third of group sites and more than a quarter of of cabins are booked six months before the start date. In contrast: consistently, only a third of tent sites are reserved 30 days in advance.

It looks like in the early years one could reserve most cabins with 6 months lead time. Then for 2012 and later years the cabin policy changed to 12 months lead time. 

Standard, tent, rv, and equestrian sites can be reserved six months in advance.

The data for 2018 and 2019 seem to have some errors, which are visible in the upper right of each plot: why are there order dates after start_date? These are the only two years in which this pattern is visible in the plots. 

I note again here that some parks have sites that are first-come-first-serve (i.e., they are not reservable). By definition those sites do not show up here.

```{r fig.height=9, fig.width=12, out.width="100%"}
nc_history %>%
  mutate(days_order_to_start = start_date - order_date,
         invalid_start_date = if_else(order_date > start_date + 1, 1, NULL),
         site_type_simple = fct_reorder(site_type_simple, person_nights, sum)
         ) %>%
  filter(year >= year_lower_bound,
         !site_type_simple %in% c("management", "shelter")) %>%
  ggplot(aes(days_order_to_start, color = site_type_simple)) +
  stat_ecdf() +
  coord_cartesian(xlim = c(360, -30)) +
  scale_x_reverse(breaks = c(0, 30, 60, 90, 180, 365)) +
  scale_y_continuous(labels = percent_format()) +
  scale_color_viridis_d(end = 0.92) +
  geom_vline(xintercept = c(0, 30, 60, 90, 180, 365), color = "firebrick", alpha = 0.5, lty = 2) +
  facet_wrap(~year, ncol = 4) +
  theme(legend.position = "bottom") +
  labs(title = "Reservation-to-start date patterns were remarkably consistent 2012-2012",
       subtitle = "Percent of NC bookings by x days before start_date",
       x = "Days before reservation starts",
       y = "",
       color = "Site type")
```

<br>

There has been a general trend towards reserving earlier:

```{r fig.height=9, fig.width=12, out.width="100%"}
nc_history %>%
  filter(year >= year_lower_bound,
         !site_type_simple %in% c("management", "shelter")) %>%
  mutate(days_order_to_start = start_date - order_date,
         invalid_start_date = if_else(order_date > start_date + 1, 1, NULL),
         
         site_type_simple = fct_reorder(site_type_simple, person_nights, sum),
         year = factor(year)
         ) %>%
  select(year, site_type_simple, days_order_to_start) %>%
  ggplot(aes(days_order_to_start, color = year)) +
  stat_ecdf() +
  coord_cartesian(xlim = c(360, -30)) +
  scale_x_reverse(breaks = c(0, 30, 60, 90, 180, 365)) +
  scale_y_continuous(labels = percent_format()) +
  scale_color_viridis_d(end = 0.92) +
  geom_vline(xintercept = c(0, 30, 60, 90, 180, 365), color = "firebrick", alpha = 0.5, lty = 2) +
  facet_wrap(~ site_type_simple, ncol = 3) +
  theme(legend.position = "bottom") +
  labs(title = "Reservations have been occuring earlier over the years\nsince 2012 for all site types",
       subtitle = "Percent of NC bookings by x days before start_date",
       x = "Days before reservation starts",
       y = "",
       color = "Site type")
```

<br>

The plots above mask differences in individual campgrounds. As you would expect some parks are more popular then others.

Most properties are seeing earlier reservations over the years. Swan Cabin is experiencing the opposite trend.

The most popular group campgrounds seem to be Cove Creek Upper and Lower Group Camp, and Kuykendall Group Camp. Other group campsites are included with other site types, so if they have the same dynamic, it's not visible in these plots.

Cabins and Group Camps are the most likely to show a linear-like increase in reservations over time (after the early birds reserve as soon as reservations open).

```{r fig.height=16, fig.width=12, out.width="100%", eval=FALSE}
# This is too much to put in one plot
nc_history %>%
  filter(year >= year_lower_bound,
         !site_type_simple %in% c("management", "shelter")) %>%
  group_by(year, facility_name) %>%
  mutate(days_order_to_start = start_date - order_date,
         invalid_start_date = if_else(order_date > start_date + 1, 1, NULL),
         
         site_type_simple = fct_reorder(site_type_simple, person_nights, sum),
         year = factor(year)
         ) %>%
  ungroup() %>%
  select(year, facility_name, site_type_simple, days_order_to_start) %>%
  ggplot(aes(days_order_to_start, color = year)) +
  stat_ecdf() +
  coord_cartesian(xlim = c(360, -30)) +
  scale_x_reverse(breaks = c(0, 30, 60, 90, 180, 365)) +
  scale_y_continuous(labels = percent_format()) +
  scale_color_viridis_d(end = 0.92) +
  geom_vline(xintercept = c(0, 30, 60, 90, 180, 365), color = "firebrick", alpha = 0.5, lty = 2) +
  facet_wrap(~ facility_name, ncol = 45) +
  theme(legend.position = "bottom") +
  labs(title = "Reservations patterns differ by campgound",
       subtitle = "Percent of NC bookings by x days before start_date",
       x = "Days before reservation starts",
       y = "",
       color = "Site type")
```

<br>

```{r fig.height=46, fig.width=18, out.width="100%"}
nc_history_for_plot <- nc_history  %>%
  filter(year >= year_lower_bound,
         !site_type_simple %in% c("management", "shelter")) %>%
  group_by(year, facility_name) %>%
  mutate(days_order_to_start = start_date - order_date,
         # invalid_start_date = if_else(order_date > start_date + 1, 1, NULL),
         
         site_type_simple = fct_reorder(site_type_simple, person_nights, sum),
         year = factor(year)
         ) %>%
  ungroup() %>%
  select(year, facility_name, site_type_simple, days_order_to_start) 

plot_order_to_start_by_site_type <- function(tbl) {
  
  site_types_in_plot <- glue_collapse(unique(tbl$site_type_simple), sep = ", ")
  
  tbl %>%
    ggplot(aes(days_order_to_start, color = year)) +
    stat_ecdf() +
    coord_cartesian(xlim = c(360, -30)) +
    scale_x_reverse(breaks = c(0, 30, 60, 90, 180, 365)) +
    scale_y_continuous(labels = percent_format()) +
    scale_color_viridis_d(end = 0.92) +
    geom_vline(xintercept = c(0, 30, 60, 90, 180, 365), color = "firebrick", alpha = 0.5, lty = 2) +
    # facet_grid(facility_name ~ site_type_simple) +
    facet_wrap(~ facility_name, ncol = 6) +
    theme(legend.position = "bottom") +
    labs(title = glue("Reservations patterns for >>{site_types_in_plot}<< site types differ by campgound"),
         subtitle = "Percent of NC bookings by x days before start_date",
         x = "Days before reservation starts",
         y = "",
         color = "Site type")
  
}
```

<br>

Judged by early reservations, Bandits Roost seems to have the most popular standard camp sites:

```{r fig.height=9, fig.width=12, out.width="100%"}
nc_history_for_plot %>%
  #filter(site_type_simple %in% c("standard", "tent")) %>%
  filter(site_type_simple %in% c("standard")) %>%
  plot_order_to_start_by_site_type(.)

```

<br>

Big Creek and Mt Pisgah have about 25% of tent sites booked 90 days before start date, followed by Badin Lake and Black Mountain. It's interesting that five of the 16 campsites only started offering reservations through recreation.gov in recent years.

```{r fig.height=9, fig.width=12, out.width="100%"}
nc_history_for_plot %>%
  filter(site_type_simple %in% c("tent")) %>%
  plot_order_to_start_by_site_type(.)

```

<br>

Cove Creek and Kuykendall group camps seem most popular, with nearly half the group reservations made a year in advance--as soon as the reservations opened. Next most popular are by Cataloochee and White Pines. Briar Bottom and North Mills River have seen remarkable increases in early reservations in recent years.

```{r fig.height=9, fig.width=12, out.width="100%"}
nc_history_for_plot %>%
  filter(site_type_simple %in% c("group")) %>%
  plot_order_to_start_by_site_type(.)

```

<br>

Wash Creek looks like the only equestrian camp to allow bookings a year in advance. Among the rest, Cataloohee has the most consistent reservation pattern over the years.

```{r fig.height=9, fig.width=12, out.width="100%"}
nc_history_for_plot %>%
  filter(site_type_simple == "equestrian") %>%
  plot_order_to_start_by_site_type(.)

```

<br>

With RV sites, Lake Powhatan and Smokemont have the biggest early surge when reservations open six months in advance.

While Powhatan has been 75% booked 30 days in advance, Linville Falls has been less 50% booked 15-20 days ahead.

```{r fig.height=9, fig.width=12, out.width="100%"}
nc_history_for_plot %>%
  filter(site_type_simple == "rv") %>%
  plot_order_to_start_by_site_type(.)

```

<br>

For the camps that allow cabin reservations a year in advance, Balsam Lake books faster than Great Island or Long Point. Of those that take bookings six months in advance, Swan books much faster than Cheoah Point.

```{r fig.height=6, fig.width=12, out.width="100%"}
nc_history_for_plot %>%
  filter(site_type_simple == "cabin") %>%
  plot_order_to_start_by_site_type(.)

```

<br>

## What does it cost per person, and how has that changed?

Median cabin cost per person doubled in 2012, and equestrian per-person cost grew 2013- 2017. Otherwise median prices were generally stable. Note that these costs are not inflation-adjusted.

Per-person costs at group and equestrian sites in 2020 seem like an aberration: either the more expensive sites were not used much, group sizes were a lot larger (seems unlikely during the pandemic), or there was some other change in usage pattern. Or there could be a problem with the data.

```{r out.width="100%"}
nc_camping_cost <- nc_history %>%
  filter(year >= year_lower_bound,
         !str_detect(site_type, "management")) %>%
  group_by(year, site_type_simple) %>%
  summarize(n = n(), 
            n_person_nights = sum(person_nights, na.rm = TRUE),
            cost_median = median(paid_person_night, na.rm = TRUE),
            cost_avg = mean(paid_person_night, na.rm = TRUE)) %>%
  ungroup()

nc_camping_cost %>%
  filter(site_type_simple != "shelter") %>%
  mutate(site_type_simple = fct_reorder(site_type_simple, cost_median, last)) %>%
 ggplot(aes(year, cost_median, color = site_type_simple)) +
  geom_line() +
  geom_point(size = 2) +
  scale_x_continuous(breaks = seq(2005, 2020, by = 5)) +
  scale_y_continuous(labels = dollar_format()) +
  scale_color_viridis_d(end = 0.92) +
  guides(color = guide_legend(reverse = TRUE)) +
  expand_limits(y = 0) +
  labs(title = "Camping in NC continues to be a great value",
       subtitle = glue("Median cost per person-night",
                    "\nat NC public campgrounds"),
       x = "",
       y = "")

```

<br>

## What is the occupancy rate at NC campgrounds? Whey are they full?

<!-- Since we cannot depend on nc_campsites to have a full, accurate list, how can we determine this? -->

<!-- 1. get n_sites for each site_type_simple from where? We could tweak the process that created nc_parks_site_types as follows ... -->
<!-- 2. assume each site for each campground + site_type_simple has been reserved at least once (thus it's in our data set). -->
<!-- 3. we can then define the count of all campsite_ids at each campground + site_type_simple to be "full occupancy" -->
<!-- 4. with daily counts of site reservations, we could then determine occupancy rates by site_type_simple based on that -->
<!-- 5. quintiles of occupancy would be interesting -->
<!-- 6. as the basis for (4) can we use nc_history_dow to get daily count for each day of the year? If not, we'll have to compute that. -->
<!-- 7. we could look at occupancy rates by year + campground + site type -->

<!-- <br> -->

<!-- The above doesn't work, since some parks use the same product_id (renamed campsite_id below) for multiple sites. Sigh. For example: "Badin Lake Group Camp + Badin Lake Campground" has only one tent campsite_id. -->

<!-- So instead we'll need to assume that each campground + site type has been fully booked at least once, and calculate the max booking for each day for the years in our data set. This will take a while to run.  -->

I define the daily percent occupancy as each day's percent of the maximum occupancy for the campground + site type. Is 100% occupancy rate the same as full occupancy? I cannot determine that from the data. Can we assume that each campgound + site time reached full occupancy? If so, then yes, 100% occupancy would mean full occupancy.

Yearly percent occupancy is the average of the occupancy rate for all days of the year.

```{r eval=FALSE}
nc_campground_site_counts_by_site_type <- nc_history %>%
  # TODO: assigning facility_id_group, etc., should be done once at the beginning
  mutate(
      name_first_word = str_extract(facility_name, "\\w+")
  ) %>% 
  # slice_sample(n = 1e5) %>% # for testing
  group_by(name_first_word) %>%
  mutate(facility_id_group = cur_group_id()
  ) %>%
  ungroup() %>%
  #distinct(name_first_word, facility_id_group, site_type_simple, .keep_all = TRUE) %>% 
  ##distinct(facility_id_group, facility_id, site_type_simple, .keep_all = TRUE) %>% 
  #select(name_first_word, facility_id, facility_name, facility_type_description, site_type_simple, facility_id_group) %>%
  group_by(facility_id_group) %>%
  mutate(facility_name = as.list(facility_name),
         facility_name_combined = glue_collapse(unique(facility_name), sep = " + "),
         facility_id_list = as.list(facility_id),
         facility_id_list = glue_collapse(unique(facility_id_list), sep = ", ")
  ) %>%
  ungroup() %>%
  arrange(facility_name_combined, site_type_simple) %>%
  rename(campsite_id = product_id) %>%
  distinct(year, facility_id_group, site_type_simple, campsite_id, .keep_all = TRUE) %>%
  #arrange(facility_name, site_type_simple) %>%
  count(year, facility_id_group, facility_name_combined, site_type_simple, name = "n_campsites")


# test
# nc_history %>%
#   #filter(facility_name == "Cedar Point Campground") %>%
#   distinct(facility_name, site_type_simple, product_id, .keep_all = TRUE) %>%
#   count(facility_name, site_type_simple, name = "n_campsites")

```

```{r year-day-occupancy}
# TODO move to facility_name_combined
nc_yday_max <- nc_yday %>%
  group_by(facility_name, site_type_simple) %>%
  slice_max(n = 1, order_by = n_campsites, with_ties = FALSE) %>%
  ungroup()

nc_yday_occupancy <- left_join(nc_yday,
                               nc_yday_max %>% 
                                 select(facility_name, site_type_simple, n_campsites_max = n_campsites),
                               by = c("facility_name", "site_type_simple")) %>%
  mutate(occupancy = n_campsites / n_campsites_max) %>%
  arrange(facility_name, year, yday_of_reservation)

# TODO: confirm this is correct then add weekly occupancy analysis
# nc_week <- tar_read(nc_camping_history_yday) %>%
#   unnest(c(week_of_reservation)) %>%
#   count(year, facility_name, site_type_simple, season, week_of_reservation,
#         name = "n_nights") %>%
#   arrange(facility_name, year, week_of_reservation)

```

```{r fig.height=9, fig.width=9, out.width="100%"}
# Now that I have % occupancy for every day at every park and site type, how to best visualize...
# * Which parks have highest occupancy (defined how?)

summary_occupancy <- nc_yday_occupancy %>%
  filter(site_type_simple != "management") %>%
  group_by(year, facility_name, site_type_simple) %>%
  summarize(avg_occupancy = mean(occupancy),
            median_occupancy = median(occupancy)) %>%
  ungroup()

year_start <- 2013
year_stop <- 2020

top_occupancy_by_year <- summary_occupancy %>%
  filter(between(year, year_start, year_stop)) %>%
  filter(site_type_simple != "management") %>%
  arrange(year, -avg_occupancy) %>%
  group_by(year, site_type_simple) %>%
  slice_max(n = 1, order_by = avg_occupancy) %>%
  ungroup() 

top_occupancy_by_year %>%
  mutate(facility_label = str_remove(facility_name, " Camp(\\w+)?")) %>%
  ggplot(aes(year, avg_occupancy, color = site_type_simple)) +
  geom_line(alpha = 0.5, size = 0.2) +
  geom_point() +
  geom_text_repel(aes(label = facility_label),
            hjust = 0,
            nudge_x = 0.05,
            show.legend = FALSE) +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  #facet_wrap(~year) +
  theme(legend.position = "bottom",
        panel.grid.major.x = element_blank()) +
  labs(title = "NC camping highest avg occupancy by year and site type",
       subtitle = glue("{year_start}-{year_stop}"),
       x = "")


```

<br>

The difference in occupancy rates off-season and during the summer are not as different as I expected. This may be due to the climate in NC: the most pleasant times to camp are in the spring and fall. Scouting and other community groups are most likely to camp in the off-season (while school is in session).

```{r fig.height=9, fig.width = 9, out.width="100%"}
top_occupancy_by_year_season <- nc_yday_occupancy %>%
  filter(between(year, year_start, year_stop)) %>%
  filter(site_type_simple != "management") %>%
  group_by(year, facility_name, season, site_type_simple) %>%
  summarize(avg_occupancy = mean(occupancy),
            median_occupancy = median(occupancy)) %>%
  ungroup() %>%
  arrange(year, season, -avg_occupancy) %>%
  group_by(year, season, site_type_simple) %>%
  slice_max(n = 1, order_by = avg_occupancy) %>%
  ungroup() 

top_occupancy_by_year_season %>%
  mutate(facility_label = str_remove(facility_name, " Camp(\\w+)?")) %>%
  ggplot(aes(year, avg_occupancy, color = site_type_simple)) +
  geom_line(alpha = 0.5, size = 0.2) +
  geom_point(size = 2) +
  geom_text_repel(aes(label = facility_label),
            hjust = 0,
            nudge_x = 0.05,
            show.legend = FALSE) +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  expand_limits(y = 0) +
  facet_wrap(~season) +
  theme(legend.position = "bottom",
        panel.grid.major.x = element_blank()) +
  labs(title = "NC camping highest avg occupancy by year and site type",
       subtitle = glue("{year_start}-{year_stop}"),
       x = "")
       
```

<br>

What if we consider only Friday and Saturday nights, the most popular nights for camping?
  
```{r fig.height=9, fig.width = 9, out.width="100%"}
top_occupancy_by_year_season <- nc_yday_occupancy %>%
  filter(between(year, year_start, year_stop)) %>%
  filter(site_type_simple != "management",
         days_of_reservation %in% c("Fri", "Sat")) %>%
  group_by(year, facility_name, season, site_type_simple) %>%
  summarize(avg_occupancy = mean(occupancy),
            median_occupancy = median(occupancy)) %>%
  ungroup() %>%
  arrange(year, season, -avg_occupancy) %>%
  group_by(year, season, site_type_simple) %>%
  slice_max(n = 1, order_by = avg_occupancy) %>%
  ungroup() 

top_occupancy_by_year_season %>%
  mutate(facility_label = str_remove(facility_name, " Camp(\\w+)?")) %>%
  ggplot(aes(year, avg_occupancy, color = site_type_simple)) +
  geom_line(alpha = 0.5, size = 0.2) +
  geom_point(size = 2) +
  geom_text_repel(aes(label = facility_label),
            hjust = 0,
            nudge_x = 0.05,
            show.legend = FALSE) +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  expand_limits(y = 0) +
  facet_wrap(~season) +
  theme(legend.position = "bottom",
        panel.grid.major.x = element_blank()) +
  labs(title = "NC camping highest avg occupancy by year and site type",
       subtitle = glue("Friday and Saturday nights only {year_start}-{year_stop}"),
       x = "")
       
```
<br>
 
How many days have campground + site type experienced max occupancy? Frankly, not as many as I expected.

<br>

```{r}
max_occupancy_by_year_season <- nc_yday_occupancy %>%
  filter(between(year, year_start, year_stop)) %>%
  filter(site_type_simple != "management",
         occupancy == 1) %>%
  #group_by(year, facility_name, season, site_type_simple) %>%
  # summarize(avg_occupancy = mean(occupancy),
  #           median_occupancy = median(occupancy)) %>%
  # ungroup() %>%
  arrange(year, season, -occupancy) #%>%
  # group_by(year, season, site_type_simple) %>%
  # slice_max(n = 1, order_by = avg_occupancy) %>%
  # ungroup() 

max_occupancy_by_year_season %>%
  count(facility_name, site_type_simple) %>%
  arrange(-n) %>%
  # since every park and site type will be at max occupancy at least once (by definition!), we'll ignore those
  filter(n > 1) %>%
  gt() %>%
  tab_header(md(glue("**Number of days facilities were at max occupancy**<br>{year_start}-{year_stop} by site type"))) #%>%

# TODO: add number of sites, since it's easier to parks with few sites to have higher occupancy
# TODO move to facility_name_combined

```

<br><br>

What about days > 90% occupancy instead of 100%?

<br>

```{r}
max_occupancy_by_year_season <- nc_yday_occupancy %>%
  filter(site_type_simple != "management",
         occupancy >= 0.9) %>%
  #group_by(year, facility_name, season, site_type_simple) %>%
  # summarize(avg_occupancy = mean(occupancy),
  #           median_occupancy = median(occupancy)) %>%
  # ungroup() %>%
  arrange(year, season, -occupancy) #%>%
  # group_by(year, season, site_type_simple) %>%
  # slice_max(n = 1, order_by = avg_occupancy) %>%
  # ungroup() 

max_occupancy_by_year_season %>%
  count(facility_name, site_type_simple) %>%
  arrange(-n) %>%
  # since every park and site type will be at max occupancy at least once (by definition!), we'll ignore those
  filter(n > 1) %>%
  gt() %>%
  tab_header(md(glue("**Number of days facilities were at least 90% occupied**<br>{year_start}-{year_stop} by site type"))) #%>%

# TODO: finish consolidating to one row per facility_id_group, then use this instead
# xx <- max_occupancy_by_year_season %>%
#   count(facility_name, site_type_simple) %>%
#   mutate(temp = 1) %>%
#   pivot_wider(names_from = site_type_simple, values_from = temp)
#   arrange(-n) %>%
#   # since every park and site type will be at max occupancy at least once (by definition!), we'll ignore those
#   filter(n > 1) %>%
#   gt() %>%
#   tab_header(md(glue("**Number of days facilities were at least 90% occupied**<br>2013 - 2020 by site type"))) #%>%

# TODO: add number of sites, since it's easier to parks with few sites to have higher occupancy
# TODO move to facility_name_combined

```


<br><br>

```{r}
# * When in the year did parks hit peak occupancy? Is it the same for each site_type?
# * Are there parks and site types for which 2020 had unusually high or low occupancy?
# * What is the rhythm of occupancy through the year? for the N parks with the most sites?

# Ave occupancy for each yday at each park + site type

# xx <- nc_yday_occupancy %>%
#   group_by(facility_name, site_type_simple, yday_of_reservation) %>%
#   summarize(avg_occupancy = mean(occupancy),
#             median_occupancy = median(occupancy)) %>%
#   ungroup()
```

<br>

# Appendix

## There is some reuse of product_id values (unfortunately)

This complicates matters. Since `product_id` is not unique in all cases, I will ...

<br>

```{r}

# test
nc_history_test <- tar_read(nc_camping_history)

n_sites <- nc_history_test %>%
  summarize(n = n_distinct(product_id)) %>%
  pull(n)

n_sites_by_facilility_id <- nc_history_test %>%
  group_by(facility_id) %>%
  summarize(n = n_distinct(product_id)) %>%
  ungroup() %>%
  pull(n) %>%
  sum()

n_sites_by_facilility_id_site_type_simple <- nc_history_test %>%
  group_by(facility_id, site_type_simple) %>%
  summarize(n = n_distinct(product_id)) %>%
  ungroup() %>%
  pull(n) %>%
  sum()

n_sites_by_facilility_id_site_type <- nc_history_test %>%
  group_by(facility_id, site_type) %>%
  summarize(n = n_distinct(product_id)) %>%
  ungroup() %>%
  pull(n) %>%
  sum()

tribble(
  ~ counting_method, ~ n_sites,
  "summarize(n = n_distinct(product_id))", n_sites,
  "group_by(facility_id) %>%
  summarize(n = n_distinct(product_id)) %>%
  ungroup() %>%
  pull(n) %>%
  sum()", n_sites_by_facilility_id,
  "group_by(facility_id, site_type_simple) %>%
  summarize(n = n_distinct(product_id)) %>%
  ungroup() %>%
  pull(n) %>%
  sum()", n_sites_by_facilility_id_site_type_simple,
  "group_by(facility_id, site_type) %>%
  summarize(n = n_distinct(product_id)) %>%
  ungroup() %>%
  pull(n) %>%
  sum()", n_sites_by_facilility_id_site_type
) %>%
  gt() %>%
  tab_header(md("***Counting sites in nc_history***<br>*product_id* is not unique in all cases")) %>%
  fmt_number(columns = 2,
             decimals = 0)
```

<br><br>

## NC Inventory added to recreation.gov

It seems recreation.gov included existing NC inventory by 2008. So we will start with `r year_lower_bound` in most cases.

```{r}
parks_nc_all_years_overnight_for_plot <- park_years %>%
  filter(facility_state == "NC") %>%
  group_by(facility_id, facility_name, site_type_simple) %>%
  summarize(n_years = n(),
            year_min = min(start_year, na.rm = TRUE),
            year_max = max(start_year, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  filter(site_type_simple != "management") %>%
  mutate(site_type_simple = fct_reorder(site_type_simple, -n_years))

```

```{r fig.width=7}
parks_nc_all_years_overnight_for_plot %>%
  count(year_min, site_type_simple) %>%
  ggplot(aes(x = year_min, y = n, fill = site_type_simple)) +
  #geom_area(stat = "identity") +
  geom_col() +
  scale_y_continuous(label = comma_format()) +
  scale_fill_viridis_d(end = 0.92, direction = -1) +
  labs(title = "Number of NC facilities newly offering site_type_simple with 'Overnight' use_type by year",
       subtitle = glue("As represented in published recreation.gov data set",
                       " {min(parks_nc_all_years_overnight_for_plot$year_min)}", 
                       " to {max(parks_nc_all_years_overnight_for_plot$year_min)}",
                       "\nBy 2008 it seems existing sites were reservable; later years are likely organic growth"),
       x = "Year newly offering overnight reservations for each kind of site at recreation.gov",
       y = "Number of facilities in NC",
       fill = "Site type"
  )
```

<br>

## USA-level data

<br><br>

NC inventory on-boarding at recreation.gov seems consistent with the rest of the USA: 2008 was the first year that recreation.gov was able to offer reservations on nearly all of the existing camping facilities across the USA. So comparing later years with a 2009 baseline provides our best view of increasing inventory in the parks. It's possible some new or existing parks came on-line as well. See the NC data further below for some parks like this.

```{r}
year_lower_bound <- 2009

parks_all_years_overnight_for_plot <- park_years %>%
  group_by(facility_id, facility_name, site_type_simple) %>%
  summarize(n_years = n(),
            year_min = min(start_year, na.rm = TRUE),
            year_max = max(start_year, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  filter(site_type_simple != "management") %>%
  mutate(site_type_simple = fct_reorder(site_type_simple, -n_years))

```

```{r fig.width=7}
parks_all_years_overnight_for_plot %>%
  count(year_min, site_type_simple) %>%
  ggplot(aes(x = year_min, y = n, fill = site_type_simple)) +
  #geom_area(stat = "identity") +
  geom_col() +
  scale_y_continuous(label = comma_format()) +
  scale_fill_viridis_d(end = 0.92, direction = -1) +
  labs(title = "Number of facilities newly offering site_type_simple with 'Overnight' use_type by year",
       subtitle = glue("As represented in published recreation.gov data set",
                       " {min(parks_all_years_overnight_for_plot$year_min)}", 
                       " to {max(parks_all_years_overnight_for_plot$year_min)}",
                       "\nStartin in {year_lower_bound} it seems existing sites were reservable; later years are likely organic growth"),
       x = "Year newly offering overnight reservations for each kind of site at recreation.gov",
       y = "Number of facilities in the USA",
       fill = "Site type"
  )
```

<br>

## Limitations

Some limitations. For example:

* Yellowstone Hotel and Cabins are not reservable via recreation.gov, but campgrounds and backcountry camping permits are
* Yosemite Creek Campground is not reservable, but other campgrounds are
* No overnight facilities in Hawaii are reservable (are there any?)
* In contrast: Great Smokey Mountain National Park campgrounds are all reservable

There are a number of kinds of sites that can be reserved overnight. For the whole USA in 2020^[I am assuming all public facilities make use of the reservation system at recreation.gov and that the data is complete. These may not be accurate assumptions, particular the second one. See ***<what?>***]:

some recreation areas allow camping; only two are reservable (and are not included in this analysis).

I wasn't able to find a definition of a "standard" (or confirm that all facilities use the same definition). At a minimum we can assume it includes tent camping. Perhaps it means test or rv?

<br>

## Troubleshooting

TODO: delete/rework (it's no longer "troubleshooting")

There is something wrong with park_years after 2015:

```{r}
#test
park_years %>%
  group_by(start_year) %>%
  tally() %>%
  gt() %>%
  tab_header(md("**Facilities in USA offering overnight reservations**<br>(each site_type_simple counted separately)"))
```

<br>

But apparently not with nc_history (which read and processed the historical CSV files separately):

```{r}
nc_history %>%
  filter(year >= year_lower_bound) %>%
  group_by(year) %>%
  tally() %>%
  gt() %>%
  tab_header(md("**NC reservations by year**"))
```

<br><br>

```{r usa-by-state}
park_years %>%
  filter(start_year == 2020) %>%
  distinct(facility_state, facility_id, site_type_simple, .keep_all = TRUE) %>%
  group_by(facility_state) %>%
  mutate(n_parks = n_distinct(facility_name)) %>%
  ungroup() %>%
  group_by(facility_state, n_parks, site_type_simple) %>%
  summarize(n_sites = n()) %>%
  ungroup() %>%
  pivot_wider(names_from = "site_type_simple", values_from = "n_sites") %>%
  select(facility_state, n_parks, standard, tent, cabin, group, rv, equestrian, shelter, management, other) %>%
  adorn_totals(where = c("row")) %>%
  gt() %>%
  tab_header(md(glue("***Public parks with overnight camping***", 
                     "<br>with reservations at recreation.gov in 2020"))) %>%
  tab_spanner(
    label = "Number of parks offering site type",
    columns = standard:other
  ) %>%
  tab_footnote(md("*Other includes 'boat in', 'anchorage', 'mooring', 'zone' and a few others*"),
               cells_column_labels(columns = other)) %>%
  fmt_number(columns = n_parks:other,
             decimals = 0) %>%
  fmt_missing(columns = everything(),
              missing_text = "")
```

<br><brt>

Starting in 2009 each year saw a very small number of campgrounds adding newly reservable overnight site types. Again, these are for the whole USA.

```{r fig.height=6}
parks_all_years_overnight_for_plot %>%
  filter(year_min >= year_lower_bound) %>%
  ggplot(aes(year_min, fill = site_type_simple)) +
  geom_histogram(binwidth = 1) +
  scale_x_continuous(breaks = c(2005, 2010, 2015, 2020)) +
  facet_wrap(~site_type_simple) +
  scale_fill_viridis_d(end = 0.92, direction = -1) +
  labs(title = "Number of facilities newly offering site_type_simple with 'Overnight' use_type by year (2009+)",
       subtitle = glue("As represented in published recreation.gov data set",
                       " {year_lower_bound}", 
                       " to {max(parks_all_years_overnight_for_plot$year_min)}"),
       x = "Year newly offering reservations for each kind of site offer overnight reservations at recreation.gov",
       y = "Number of facilities in the USA",
       fill = "Site type"
  )
```
<br>

It seems like normal growth in in 2009 and following years as facilities additional types of sites and perhaps some new facilities opened. The overall compound growth rate^[Growth rate in the number of facilities offering the various type of overnight sites, each option at each facility counted once.] between %YYYY% and 2020 was %CAGR%, with some differences in the kinds of sites:

```{r fig.height=4}
#from https://datascience.stackexchange.com/questions/26347/compound-annual-growth-rate-function-in-r-statistics
CAGR_formula <- function(FV, PV, yrs) {
  (FV/PV)^(1/yrs)-1
}

parks_all_years_overnight_for_plot <- park_years %>%
  filter(site_type_simple != "management",
         start_year >= year_lower_bound) %>%
  group_by(start_year, site_type_simple) %>%
  summarize(n_parks = n()) %>%
  ungroup() %>%
  group_by(site_type_simple) %>%
  mutate(#agr_by_site_type = sum(n_parks[start_year == 2020]) / sum(n_parks[start_year == 2008]) / (2020 - 2008),
         cagr_by_site_type = CAGR_formula(sum(n_parks[start_year == 2020]), 
                                          sum(n_parks[start_year == year_lower_bound]), 
                                          2020 - year_lower_bound)
         ) %>%
  ungroup() %>%
  mutate(site_type_simple_label = glue("{site_type_simple} ({percent(cagr_by_site_type, accuracy = 0.1)})"),
    site_type_simple_label = fct_reorder(site_type_simple_label, -n_parks)) 

# agr <- with(parks_all_years_overnight_for_plot,
#             round(sum(n_parks[start_year == 2020]) / sum(n_parks[start_year == year_lower_bound])) / (2020 - year_lower_bound + 1), 0)

cagr <- with(parks_all_years_overnight_for_plot,
             CAGR_formula(sum(n_parks[start_year == 2020]), sum(n_parks[start_year == year_lower_bound]), yrs = 2020 - year_lower_bound + 1)
             )
  
parks_all_years_overnight_for_plot %>%
  ggplot(aes(start_year, n_parks, color = site_type_simple_label)) +
  geom_line() +
  geom_point(size = 2) +
  scale_x_continuous(breaks = c(2005, 2010, 2015, 2020)) +
  scale_color_viridis_d(end = 0.92, direction = -1) +
  labs(title = "Number of facilities offering site_type_simple with 'Overnight' use_type by year",
       subtitle = glue("Compound annual growth rate (CAGR) for all offering site types: {percent(cagr, accuracy = 0.1)}",
                       " from {min(parks_all_years_overnight_for_plot$start_year)} to",
                       " {max(parks_all_years_overnight_for_plot$start_year)}",
                       "\nAs represented in published recreation.gov data set"),
       x = "Reservation start year",
       color = "Site type (CAGR)")
```

<br>

(end of USA section)

<br>
<br>

# TODO

* filter on year_lower_bound in all appropriate places
* use facility_name_combined in all appropriate places
* fix graph zooming in knitr output
* confirm what last day means: is it checkout date or last night? If the former, then we should remove it when calculating occupancy.

