---
title: "Explore regressions (experimental)"
author: "Daniel Moul"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_depth: 3
    number_sections: true
    #theme: united
    #code_folding: show
---

<br>

***This is an experimental script. See nc-camping-writeup.Rmd for the main write-up. It's OK to run this script in it's entirely, but you need to have a bunch of Stan-related packages installed (and it take a while to run).***

<br>

```{r setup, include=FALSE}
library(here)
source(here("scripts", "my-setup.R"))

library(lme4)
library(broom.mixed)

# following https://mc-stan.org/cmdstanr/articles/cmdstanr.html
# we recommend running this is a fresh R session or restarting your current session
# install.packages("cmdstanr", repos = c("https://mc-stan.org/r-packages/", getOption("repos")))
# installed cmdstan: Since check_cmdstan_toolchain() was good, I ran install_cmdstan(cores = 4)
# got this result: CmdStan path set to: /Users/dmoul/.cmdstanr/cmdstan-2.28.2
library(brms)
library(cmdstanr)
library(posterior)
library(bayesplot)
color_scheme_set("brightblue")

mc.cores = 4 # used by defaul by brm() and loo()

#knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
knitr::opts_chunk$set(echo = TRUE, warning = TRUE, message = TRUE)

```

<!-- enable horizontal scrolling in chunk output -->
<!-- following https://github.com/yihui/rmarkdown-cookbook/issues/111 -->
<style>
pre {
  overflow-x: auto;
}
pre code {
  word-wrap: normal;
  white-space: pre;
}
</style>

```{r read-target-objects, echo=FALSE}
nc_history <- tar_read(nc_camping_history) %>%
  mutate(
    facility_name = case_when(
      #str_detect(facility_name, "Cheoah Point Cabin \\d")                                     ~ "Cheoah Point Cabins",
      str_detect(facility_name, "Big Creek Campground \\(Great Smoky Mountains National Park\\)") ~ "Big Creek Campground",
      #str_detect(facility_name, "Cove Creek [Upper|Lower] Group Camp")                        ~ "Cove Creek Group Camp",
      str_detect(facility_name, "Curtis Creek Campground \\(Nc\\)")                           ~ "Curtis Creek Campground",
      TRUE                                                                                    ~ facility_name
    ),
    # Fix an error
    facility_latitude = if_else(facility_name == "Cape Point Campground", 35.235278, facility_latitude),
    facility_longitude = if_else(facility_name == "Cape Point Campground", -75.535278, facility_longitude),
    # We'll use this a lot, so let's create it once
    year = year(start_date)
  )

nc_parks_site_types <- nc_history %>%
  mutate(
      name_first_word = str_extract(facility_name, "\\w+")
  ) %>%
  # slice_sample(n = 1e5) %>% # for testing
  # This works because each first word is unique--it probably wouldn't work if looking at whole USA
  group_by(name_first_word) %>%
  mutate(facility_id_group = cur_group_id()
  ) %>%
  ungroup() %>%
  group_by(facility_id_group, site_type) %>%
  mutate(n_sites = n_distinct(product_id)) %>%
  ungroup() %>%
  ##distinct(name_first_word, facility_id_group, site_type, .keep_all = TRUE) %>%
  distinct(facility_id_group, facility_id, site_type, .keep_all = TRUE) %>%
  select(name_first_word, facility_id, facility_name, facility_type_description, site_type, facility_id_group, n_sites) %>%
  group_by(facility_id_group) %>%
  mutate(facility_name = as.list(facility_name),
         facility_name = glue_collapse(unique(facility_name), sep = " + "),
         facility_id_list = as.list(facility_id),
         facility_id_list = glue_collapse(unique(facility_id_list), sep = ", ")
  ) %>%
  ungroup() %>%
  arrange(facility_name, site_type)
# one row for each facility_name (combined) and site_type
# for cases where only the facility_name ang or facility_group_id matters, use distinct()
```

```{r read-target-objects-not-used, eval=FALSE, echo=FALSE}
# data frames not used

# facilities <- tar_read(facilities_all)
# 
# federal_org_info <- tar_read(federal_orgs)

# year_min <- year_lower_bound
# year_max <- max(nc_history$year)
# 
# nc_history_dow <- tar_read(nc_camping_history_dow) %>%
#   mutate(year = year(start_date))
# 
# nc_parks_site_types_product_id <- nc_history %>%
#   #tail(10000) %>%
#   mutate(
#       name_first_word = str_extract(facility_name, "\\w+")
#   ) %>% 
#   # slice_sample(n = 1e5) %>% # for testing
#   group_by(name_first_word) %>%
#   mutate(facility_id_group = cur_group_id()
#   ) %>%
#   ungroup() %>%
#   group_by(facility_id_group, site_type) %>%
#   mutate(product_id_list = list(unique(product_id)),
#          n_sites = length(product_id_list)) %>%
#   ungroup() %>%
#   ##distinct(name_first_word, facility_id_group, site_type, .keep_all = TRUE) %>% 
#   distinct(facility_id_group, facility_id, site_type, .keep_all = TRUE) %>% 
#   select(name_first_word, facility_id, facility_name, facility_type_description, site_type, facility_id_group, n_sites) %>%
#   group_by(facility_id_group) %>%
#   mutate(facility_name = as.list(facility_name),
#          facility_name = glue_collapse(unique(facility_name), sep = " + "),
#          facility_id_list = as.list(facility_id),
#          facility_id_list = glue_collapse(unique(facility_id_list), sep = ", ")
#   ) %>%
#   ungroup() %>%
#   arrange(facility_name, site_type)
# # one row for each facility_name (combined) and site_type
# # for cases where only the facility_name ang or facility_group_id matters, use distinct()

# nc_campsites <- tar_read(nc_campsites_from_history) %>%
#   mutate(facility_name = case_when(
#     #str_detect(facility_name, "Cheoah Point Cabin \\d")                                     ~ "Cheoah Point Cabins",
#     str_detect(facility_name, "Big Creek Campground \\(Great Smoky Mountains National Park\\)") ~ "Big Creek Campground",
#     #str_detect(facility_name, "Cove Creek [Upper|Lower] Group Camp")                        ~ "Cove Creek Group Camp",
#     str_detect(facility_name, "Curtis Creek Campground \\(Nc\\)")                           ~ "Curtis Creek Campground",
#     TRUE                                                                                    ~ facility_name
#   )
#   ) %>%
#   rename(facility_name_original = facility_name) %>%
#   left_join(.,
#             nc_parks_site_types %>%
#               select(facility_id_group, facility_name, facility_id = facility_id_list) %>%
#               separate_rows(facility_id),
#             by = "facility_id"
#             ) %>%
#   distinct(facility_id_group, facility_name, campsite_id)
  
# feather file seems to be flakey, so using targets() cached value instead
# park_years <- readRDS("./data/processed/park-years.rds") %>% # could use .rds if we wanted to
# park_years <- tar_read(park_years_usa) %>%  
#   filter(facility_name != "Washington Monument",
#          !is.na(start_year)) %>%
#   # Fix an error
#   mutate(
#     facility_latitude = if_else(facility_name == "Cape Point Campground", 35.235278, facility_latitude),
#     facility_longitude = if_else(facility_name == "Cape Point Campground", -75.535278, facility_longitude)
# )
## park_years <- park_years_rds %>%
##   filter(facility_name != "Washington Monument")

# nc_yday <- tar_read(nc_camping_history_yday) %>%
#   unnest(c(days_of_reservation, yday_of_reservation)) %>%
#   count(year, facility_name, site_type, season, days_of_reservation, yday_of_reservation,
#         name = "n_campsites") %>%
#   arrange(facility_name, year, yday_of_reservation)
# 
# nc_week <- tar_read(nc_camping_history_yday) %>%
#   unnest(week_of_reservation, yday_of_reservation) %>%
#   count(year, facility_name, site_type, season, week_of_reservation, #n_campgrounds, 
#         name = "n_campsites") %>%
#   arrange(facility_name, year, week_of_reservation, site_type)
# 
# nc_week_n_camps_occupied <- tar_read(nc_camping_history_yday) %>%
#   filter(year >= year_lower_bound,
#          site_type != "management") %>%
#   distinct(year, week_of_reservation, facility_name, site_type) %>%
#   mutate(week_of_reservation = map(week_of_reservation, unique)) %>%
#   unnest(week_of_reservation) %>%
#   distinct(year, week_of_reservation, facility_name, site_type) %>%
#   group_by(year, week_of_reservation, site_type) %>%
#   summarize(n_campgrounds = n_distinct(facility_name)) %>%
#   ungroup()

```

```{r}
year_end <- 2019

nc_camping_person_nights_and_revenue <- nc_history %>%
  mutate(year = year(start_date)) %>%
  filter(between(year, year_lower_bound, year_end),
         !str_detect(site_type, "management")) %>%
  rename(facility_name_original = facility_name) %>%
  mutate(facility_first_word = str_extract(facility_name_original, "\\w+"),
         year = year - year_lower_bound + 1) %>% # year 1 is 2009
  inner_join(.,
             nc_parks_site_types %>%
               select(facility_id_group, facility_name, facility_id_list) %>%
               mutate(facility_first_word = str_extract(facility_name, "\\w+")),
             by = "facility_first_word") %>%
  filter(!str_detect(site_type, "management")) %>%
  group_by(year, facility_name) %>%
  summarize(n_reservations = n(),
            revenue_in_year = sum(total_paid, na.rm = TRUE),
            person_nights = sum(person_nights)
            ) %>%
  ungroup() %>%
  mutate(n_reservations_c = n_reservations - mean(n_reservations),
            revenue_in_year_c = revenue_in_year - mean(revenue_in_year),
            person_nights_c = person_nights - mean(person_nights)
  )

```

```{r}
nc_camping_person_nights_and_revenue_site_type <- nc_history %>%
  mutate(year = year(start_date)) %>%
  filter(between(year, year_lower_bound, year_end),
         !str_detect(site_type, "management")) %>%
  rename(facility_name_original = facility_name) %>%
  mutate(facility_first_word = str_extract(facility_name_original, "\\w+"),
         year = year - year_lower_bound + 1) %>% # year 1 is 2009
  inner_join(.,
             nc_parks_site_types %>% 
               select(facility_id_group, facility_name, facility_id_list) %>%
               mutate(facility_first_word = str_extract(facility_name, "\\w+")),
             by = "facility_first_word") %>%
  group_by(year, facility_name_original, facility_id, facility_id_list, 
           facility_first_word, facility_name, facility_id_group, 
           site_type) %>%
  summarize(n_reservations = n(), 
            revenue_in_year = sum(total_paid, na.rm = TRUE),
            person_nights = sum(person_nights)
            ) %>%
  ungroup() %>%
  mutate(n_reservations_c = n_reservations - mean(n_reservations),
         revenue_in_year_c = revenue_in_year - mean(revenue_in_year),
         person_nights_c = person_nights - mean(person_nights),
         log_n_reservations = log(n_reservations)
  )

# note: centered values ("_c") are differences from the mean
```

<br>

```{r}
nc_camping_person_nights_and_revenue_site_type %>%
  group_by(year, site_type) %>%
  summarize(n_reservations = sum(n_reservations)) %>%
  ungroup() %>%
  mutate(site_type = fct_reorder(site_type, n_reservations),
         year = year + year_lower_bound - 1) %>% #view()
  ggplot(aes(x = year, y = n_reservations, fill = site_type)) +
  geom_area() +
  scale_x_continuous(labels = label_number(accuracy = 1, big.mark = ""),
                     breaks = (1:5) * 2 + 2008) +
  scale_y_continuous(labels = label_number_si()) +
  scale_fill_viridis_d(end = 0.92, direction = -1) +
  labs(title = "NC camping reservations",
       subtitle = glue("{year_lower_bound}-{year_end}"),
       x = NULL,
       fill = "Site type")
```

<br>

```{r}
nc_camping_person_nights_and_revenue_site_type %>%
  group_by(year, site_type) %>%
  summarize(person_nights = sum(person_nights)) %>%
  ungroup() %>%
  mutate(site_type = fct_reorder(site_type, person_nights),
         year = year + year_lower_bound - 1) %>% #view()
  ggplot(aes(x = year, y = person_nights, fill = site_type)) +
  geom_area() +
  scale_x_continuous(labels = label_number(accuracy = 1, big.mark = ""),
                     breaks = (1:5) * 2 + 2008) +
  scale_y_continuous(labels = label_number_si()) +
  scale_fill_viridis_d(end = 0.92, direction = -1) +
  labs(title = "NC camping person_nights",
       subtitle = glue("{year_lower_bound}-{year_end}"),
       x = NULL,
       fill = "Site type")
```

<br>

```{r}
nc_camping_person_nights_and_revenue_site_type %>%
  group_by(year, site_type) %>%
  summarize(revenue_in_year = sum(revenue_in_year)) %>%
  ungroup() %>%
  mutate(site_type = fct_reorder(site_type, revenue_in_year),
         year = year + year_lower_bound - 1) %>% #view()
  ggplot(aes(x = year, y = revenue_in_year, fill = site_type)) +
  geom_area() +
  scale_x_continuous(labels = label_number(accuracy = 1, big.mark = ""),
                     breaks = (1:5) * 2 + 2008) +
  scale_y_continuous(labels = label_number_si()) +
  scale_fill_viridis_d(end = 0.92, direction = -1) +
  labs(title = "NC camping revenue",
       subtitle = glue("{year_lower_bound}-{year_end}"),
       x = NULL,
       fill = "Site type")
```

<br>

# Rationale

Multi-level aka hierarchical models are harder to understand and harder to compare. Can I construct a model that is arguably better than others in describing the dynamics in NC camping, modeling `n_reservation` ~ `year`? The more reservations, the more `person-nights` and the more `revenue_in_year`, all other things reasonably consistent.

I will start with simple linear models in fit0, intercept-only models in fit1, then proceed to hierarchical models, ending with two-group hierarchical models in fit4. I will start with linear models with lm(), then move to multi-level models with lmer(), then use Stan via brm() to do it the Bayesian way, which makes model comparison easier.

<br>

# Some simple models

## Reservations

```{r}
fit0.reservations <- lm(n_reservations ~ year,
                        data = nc_camping_person_nights_and_revenue)

fit0.reservations2 <- 
  nc_camping_person_nights_and_revenue_site_type %>%
  mutate(temp = 1) %>%
  pivot_wider(names_from = site_type, names_prefix = "dummy_", values_from = temp) %>%
  mutate(across(starts_with("dummy"), ~ ifelse(is.na(.x), 0, .x))) %>%
  lm(n_reservations ~ year + dummy_tent + dummy_group + 
       dummy_cabin + dummy_equestrian + dummy_rv,
     data = .) #dummy_standard is the base case

fit0_reservations_results <-
  bind_rows(
    bind_cols(tidy(fit0.reservations, conf.int = TRUE, conf.level = 0.9), glance(fit0.reservations)) %>% 
                mutate(fit = "fit0.reservations"),
    bind_cols(tidy(fit0.reservations2, conf.int = TRUE, conf.level = 0.9), glance(fit0.reservations)) %>% 
                mutate(fit = "fit0.reservations2")
) %>%
  select(fit, everything())

fit0_reservations_results %>%
  gt() %>%
  fmt_number(columns = c(estimate:`p.value...12`, logLik, AIC, BIC),
             decimals = 2)
```

<br><br>

```{r fig.width=9, out.width="100%"}
fit0_reservations_results %>%
  filter(term != "(Intercept)") %>%
  ggplot(aes(y = term, x = estimate, xmin = conf.low, xmax = conf.high)) +
  geom_errorbarh(height = 0.2) +
  geom_point() +
  geom_vline(xintercept = 0, color = "blue") +
  facet_wrap(~fit) +
  theme(plot.title.position = "plot") +
  labs(title  = "model terms in fit0.reservations and fit0.reservations2",
       subtitle = glue("{year_lower_bound}-{year_end} at 90% CI", 
                       "\ndummy_standard is base case in fit0.reservations2",
                       "\nmodel doesn't explain much variance: adj.r.squared = {round(unique(fit0_reservations_results$adj.r.squared), 2)}"))
```

<br>

As expected, adding the categories of `site_type` as dummy variables reduces the standard error on the year.

<br>

## Person-nights

```{r}
fit0.person_nights <- lm(person_nights ~ year,
                        data = nc_camping_person_nights_and_revenue)

fit0.person_nights2 <- 
  nc_camping_person_nights_and_revenue_site_type %>%
  mutate(temp = 1) %>%
  pivot_wider(names_from = site_type, names_prefix = "dummy_", values_from = temp) %>%
  mutate(across(starts_with("dummy"), ~ ifelse(is.na(.x), 0, .x))) %>%
  lm(person_nights ~ year + dummy_tent + dummy_group + 
       dummy_cabin + dummy_equestrian + dummy_rv,
     data = .) #dummy_standard is the base case

fit0_person_nights_results <-
  bind_rows(
    bind_cols(tidy(fit0.person_nights, conf.int = TRUE, conf.level = 0.9), glance(fit0.person_nights)) %>% 
                mutate(fit = "fit0.person_nights"),
    bind_cols(tidy(fit0.person_nights2, conf.int = TRUE, conf.level = 0.9), glance(fit0.person_nights)) %>% 
                mutate(fit = "fit0.person_nights2")
) %>%
  select(fit, everything())

fit0_person_nights_results %>%
  gt() %>%
  fmt_number(columns = c(estimate:`p.value...12`, logLik, AIC, BIC),
             decimals = 2)
```

<br><br>

```{r fig.width=9, out.width="100%"}
fit0_person_nights_results %>%
  filter(term != "(Intercept)") %>%
  ggplot(aes(y = term, x = estimate, xmin = conf.low, xmax = conf.high)) +
  geom_errorbarh(height = 0.2) +
  geom_point() +
  geom_vline(xintercept = 0, color = "blue") +
  scale_x_continuous(labels = label_number_si()) +
  facet_wrap(~fit) +
  theme(plot.title.position = "plot") +
  labs(title  = "model terms in fit0.person_nights and fit0.person_nights2",
       subtitle = glue("{year_lower_bound}-{year_end} at 90% CI", 
                       "\ndummy_standard is base case in fit0.person_nights2",
                       "\nmodel doesn't explain much variance: adj.r.squared = {round(unique(fit0_person_nights_results$adj.r.squared), 2)}"))
```

<br>

## Revenue

```{r}
fit0.revenue_in_year <- lm(revenue_in_year ~ year,
                        data = nc_camping_person_nights_and_revenue_site_type)

fit0.revenue_in_year2 <- 
  nc_camping_person_nights_and_revenue_site_type %>%
  mutate(temp = 1) %>%
  pivot_wider(names_from = site_type, names_prefix = "dummy_", values_from = temp) %>%
  mutate(across(starts_with("dummy"), ~ ifelse(is.na(.x), 0, .x))) %>%
  lm(revenue_in_year ~ year + dummy_tent + dummy_group + 
       dummy_cabin + dummy_equestrian + dummy_rv,
     data = .) #dummy_standard is the base case

fit0_revenue_in_year_results <-
  bind_rows(
    bind_cols(tidy(fit0.revenue_in_year, conf.int = TRUE, conf.level = 0.9), glance(fit0.revenue_in_year)) %>% 
                mutate(fit = "fit0.revenue_in_year"),
    bind_cols(tidy(fit0.revenue_in_year2, conf.int = TRUE, conf.level = 0.9), glance(fit0.revenue_in_year)) %>% 
                mutate(fit = "fit0.revenue_in_year2")
) %>%
  select(fit, everything())

fit0_revenue_in_year_results %>%
  gt() %>%
  fmt_number(columns = c(estimate:`p.value...12`, logLik, AIC, BIC),
             decimals = 2)
```

<br><br>

```{r fig.width=9, out.width="100%"}
fit0_revenue_in_year_results %>%
  filter(term != "(Intercept)") %>%
  ggplot(aes(y = term, x = estimate, xmin = conf.low, xmax = conf.high)) +
  geom_errorbarh(height = 0.2) +
  geom_point() +
  geom_vline(xintercept = 0, color = "blue") +
  scale_x_continuous(labels = label_number_si()) +
  facet_wrap(~fit) +
  theme(plot.title.position = "plot") +
  labs(title  = "model terms in fit0.revenue_in_year and fit0.revenue_in_year2",
       subtitle = glue("{year_lower_bound}-{year_end} at 90% CI", 
                       "\ndummy_standard is base case in fit0.revenue_in_year2",
                       "\nmodel doesn't explain much variance: adj.r.squared = {round(unique(fit0_revenue_in_year_results$adj.r.squared), 2)}"))
```

<br>

# Some multi-level models

I am starting with `r year_lower_bound` and ending with `r year_end` since 2020 was a strange year.

```{r}
df_facility <- nc_camping_person_nights_and_revenue_site_type %>%
  group_by(year, facility_name_original, facility_id, facility_name, facility_id_group, facility_first_word) %>%
  summarize(n_reservations = sum(n_reservations),
            revenue_in_year = sum(revenue_in_year, na.rm = TRUE),
            person_nights = sum(person_nights)
            ) %>%
  ungroup() %>%
  mutate(n_reservations_c = n_reservations - mean(n_reservations),
         revenue_in_year_c = revenue_in_year - mean(revenue_in_year),
         person_nights_c = person_nights - mean(person_nights),
         log_n_reservations = log(n_reservations)
  ) %>%
  mutate(across(c(facility_name_original, facility_id, facility_name), factor))

df_facility_site_type <- nc_camping_person_nights_and_revenue_site_type %>%
  mutate(across(c(facility_name_original, facility_id, facility_name, facility_first_word), factor))

```

<br>

## Intercepts-only model per facility_id

```{r}
fit1.reservations <- lmer(data = df_facility,
            formula = n_reservations_c ~ 1 + (1 | facility_first_word)
)

# note: can be written with or without the "1" in "... ~ 1 + ...

summary(fit1.reservations)
```

<br>

```{r}
fit1.person_nights <- lmer(data = df_facility,
            formula = person_nights_c ~ 1 + (1 | facility_first_word)
)

summary(fit1.person_nights)
```

<br>

```{r}
fit1.revenue <- lmer(data = df_facility,
            formula = revenue_in_year_c ~ 1 + (1 | facility_first_word)
)

summary(fit1.revenue)
```

<br>

```{r}
fit1_results <- bind_rows(
  bind_cols(tidy(fit1.reservations, conf.int = TRUE, conf.level = 0.9), glance(fit1.reservations)) %>% 
    mutate(fit = "fit1.reservations"),
  bind_cols(tidy(fit1.person_nights, conf.int = TRUE, conf.level = 0.9), glance(fit1.person_nights)) %>% 
    mutate(fit = "fit1.person_nights"),
  bind_cols(tidy(fit1.revenue, conf.int = TRUE, conf.level = 0.9), glance(fit1.revenue)) %>% 
    mutate(fit = "fit1.revenue")
) %>%
  mutate_if(is.double, round, digits = 2) %>% 
  select(fit, everything())

```

<br>

## Add `site_type`

```{r}
fit2.reservations <- lmer(data = df_facility_site_type,
            formula = n_reservations_c ~ 1 + site_type + (1 | facility_first_word)
)

summary(fit2.reservations)
```

<br>

```{r}
fit2.person_nights <- lmer(data = df_facility_site_type,
            formula = person_nights_c ~ 1 + site_type + (1 | facility_first_word)
)

summary(fit2.person_nights)
```

<br>

```{r}
fit2.revenue <- lmer(data = df_facility_site_type,
            formula = revenue_in_year_c ~ 1 + site_type + (1 | facility_first_word)
)

summary(fit2.revenue)
```

<br>

```{r}
fit2_results <- bind_rows(
  bind_cols(tidy(fit2.reservations, conf.int = TRUE, conf.level = 0.9), glance(fit2.reservations)) %>% 
    mutate(fit = "fit2.reservations"),
  bind_cols(tidy(fit2.person_nights, conf.int = TRUE, conf.level = 0.9), glance(fit2.person_nights)) %>% 
    mutate(fit = "fit2.person_nights"),
  bind_cols(tidy(fit2.revenue, conf.int = TRUE, conf.level = 0.9), glance(fit2.revenue)) %>% 
    mutate(fit = "fit2.revenue")
) %>%
  mutate_if(is.double, round, digits = 2) %>% 
  select(fit, everything())


```

<br>

## Add `year`

```{r}
fit3.reservations <- lmer(data = df_facility_site_type,
      formula = n_reservations_c ~ 1 + site_type + year + (1 | facility_first_word)
)

summary(fit3.reservations)
```

<br>

```{r}
fit3.person_nights <- lmer(data = df_facility_site_type,
      formula = person_nights_c ~ 1 + site_type + year + (1 | facility_first_word)
)

summary(fit3.person_nights)
```

<br>

```{r}
fit3.revenue <- lmer(data = df_facility_site_type,
      formula = revenue_in_year_c ~ 1 + site_type + year + (1 | facility_first_word)
)

summary(fit3.revenue)
```

<br>

```{r}
fit3_results <- bind_rows(
  bind_cols(tidy(fit3.reservations, conf.int = TRUE, conf.level = 0.9), glance(fit3.reservations)) %>% 
    mutate(fit = "fit3.reservations"),
  bind_cols(tidy(fit3.person_nights, conf.int = TRUE, conf.level = 0.9), glance(fit3.person_nights)) %>% 
    mutate(fit = "fit3.person_nights"),
  bind_cols(tidy(fit3.revenue, conf.int = TRUE, conf.level = 0.9), glance(fit3.revenue)) %>% 
    mutate(fit = "fit3.revenue")
) %>%
  mutate_if(is.double, round, digits = 2) %>% 
  select(fit, everything())


```

<br>

## Change `site_type` to be a level of the model

```{r}
fit4.reservations <- lmer(data = df_facility_site_type,
      formula = n_reservations_c ~ 1 + year + (1 | site_type) + (1 | facility_first_word)
)

summary(fit4.reservations)
```

<br>

```{r}
fit4.person_nights <- lmer(data = df_facility_site_type,
      formula = person_nights_c ~ 1 + year + (1 | site_type) + (1 | facility_first_word)
)

summary(fit4.person_nights)
```

<br>

```{r}
fit4.revenue <- lmer(data = df_facility_site_type,
      formula = revenue_in_year_c ~ 1 + year + (1 | site_type) + (1 | facility_first_word)
)

summary(fit4.revenue)
```

<br>

```{r}
fit4_results <- bind_rows(
  bind_cols(tidy(fit4.reservations, conf.int = TRUE, conf.level = 0.9), glance(fit4.reservations)) %>% 
    mutate(fit = "fit4.reservations"),
  bind_cols(tidy(fit4.person_nights, conf.int = TRUE, conf.level = 0.9), glance(fit4.person_nights)) %>% 
    mutate(fit = "fit4.person_nights"),
  bind_cols(tidy(fit4.revenue, conf.int = TRUE, conf.level = 0.9), glance(fit4.revenue)) %>% 
    mutate(fit = "fit4.revenue")
) %>%
  mutate_if(is.double, round, digits = 2) %>% 
  select(fit, everything())


```

<br>


#+ Some comparsions

# Considering REMLcrit and anova

`reservations` offers the lowest REMLcrit. Note that we cannot compare fit1 with fit2 and fit3, since fit1 has fewer rows of data.

```{r}
fit1_results %>%
  distinct(fit, .keep_all = TRUE) %>%
  select(fit, REMLcrit)
```

<br>

```{r}
fit2_results %>%
  distinct(fit, .keep_all = TRUE) %>%
  select(fit, REMLcrit)
```

<br>

Again `reservations` is better than `person_nights` or `revenue`. I note fit3 is slightly better (lower) than fit2 for all three predictors.

```{r}
fit3_results %>%
  distinct(fit, .keep_all = TRUE) %>%
  select(fit, REMLcrit)
```

<br>

```{r}
fit4_results %>%
  distinct(fit, .keep_all = TRUE) %>%
  select(fit, REMLcrit)
```

<br>

Some notes

REML = restricted (or residual, or reduced) maximum likelihood (REML) https://en.wikipedia.org/wiki/Restricted_maximum_likelihood

But one shouldn't use AIC (or BIC?) to compare two models with different fixed effects that are fitted by REML, since it will generally lead to nonsense as discussed at https://stats.stackexchange.com/questions/116770/reml-or-ml-to-compare-two-mixed-effects-models-with-differing-fixed-effects-but


<br>

### By reservation type

```{r}
anova(fit2.reservations, fit3.reservations, fit4.reservations)
```

<br>

```{r}
anova(fit2.person_nights, fit3.person_nights, fit4.person_nights)
```

<br>

```{r}
anova(fit2.revenue, fit3.revenue, fit4.revenue)
```

<br>

### By model generation

```{r}
anova(fit2.reservations, fit2.person_nights, fit2.revenue)
```

<br>

```{r}
anova(fit3.reservations, fit3.person_nights, fit3.revenue)
```

<br>

```{r}
anova(fit4.reservations, fit4.person_nights, fit4.revenue)
```

<br>

# Now with brms

## Fit the models with brm()

fit1b.reservations is not a good fit. We don't have enough Bulk_ESS.

```{r}
fit1b.reservations <- brm(n_reservations ~ 1 + (1 | facility_name_original), 
                          data = df_facility,
                          save_pars = save_pars(all = TRUE),
                          cores  = 4,
                          backend = "cmdstanr"
) 

summary(fit1b.reservations)
```

<br>

fit2b is much better than fit1b

```{r}
fit2b.reservations <- brm(n_reservations ~ 1 + site_type + (1 | facility_name_original), 
                          data = df_facility_site_type,
                          save_pars = save_pars(all = TRUE),
                          cores  = 4,
                          silent = 2, # fewer messages while running)
                          backend = "cmdstanr"
)

summary(fit2b.reservations)
```

<br>

fit3b is even better.

```{r}
fit3b.reservations <- brm(n_reservations ~ 1 + site_type + year + (1 | facility_name_original), 
                          data = df_facility_site_type,
                          save_pars = save_pars(all = TRUE),
                          cores  = 4,
                          silent = 2, # fewer messages while running
                          backend = "cmdstanr"
)

summary(fit3b.reservations)
```


<br>

Turning site_type into a group effect in fit4b...

```{echo=FALSE, include=FALSE}
I had some challenges

Rhat is good, but sometimes I get "Warning: There were 3 divergent transitions after warmup."

The unserialize error described below disappeared when I moved to cmdstanr as the backend (instead of rstan)

To address that I tried changing adapt_delta. But now I am getting


SAMPLING FOR MODEL '12a0d066cbcec62b0f1d9e209e27a780' NOW (CHAIN 1).
Error in unserialize(socklist[[n]]) : error reading from connection


when including control in 


fit4b.reservations <- brm(n_reservations ~ 1 + year + (1 | site_type) + (1 | facility_id), 
                          data = df_facility_site_type,
                          cores  = 4,
                          silent = 2, # fewer messages while running
                          control = list(adapt_delta = 0.9) # to avoid divergent transitions after warmup
                          )


This didn't help: Following https://discourse.mc-stan.org/t/error-in-unserialize-socklist-n-error-reading-from-connection/18097/8 and creating Makevars without '-march=native'

Can I add comments to Makevars? If so, I would include these:

* # following advice at https://discourse.mc-stan.org/t/error-in-unserialize-socklist-n-error-reading-from-connection/18097/8
* # 2021-12-12

```

```{r}
fit4b.reservations <- brm(n_reservations ~ 1 + year + (1 | site_type) + (1 | facility_name_original), 
                          data = df_facility_site_type,
                          save_pars = save_pars(all = TRUE),
                          cores  = 4,
                          silent = 2, # fewer messages while running
                          control = list(adapt_delta = 0.95), # to reduce/avoid divergent transitions after warmup
                          backend = "cmdstanr"
)

summary(fit4b.reservations)
```

<br>

```{r fig.height=9, fig.width=9, out.width="100%"}
#pairs(fit4b.reservations)
plot(fit4b.reservations)
```

<br>

## LOO model comparisons

```{r loo_1b}
loo_1b <- loo(fit1b.reservations, moment_match = TRUE, reloo = TRUE)
print(loo_1b)
```
<br>

```{r loo_2b}
loo_2b <- loo(fit2b.reservations, moment_match = TRUE, reloo = TRUE)
print(loo_2b)
```

<br>

```{r loo_3b}
loo_3b <- loo(fit3b.reservations, moment_match = TRUE, reloo = TRUE)
print(loo_3b)
```

<br>

```{r loo_4b}
loo_4b <- loo(fit4b.reservations, 
              moment_match = TRUE, reloo = TRUE)
print(loo_4b)
```

<br>

The best model (thus far) is fit3b:

```{r}
loo_compare(loo_2b, loo_3b, loo_4b)
```

<br>

## Model parameter distributions

```{r fig.height=10, fig.width=10, out.width="100%"}
# following examples at https://mc-stan.org/bayesplot/
posterior <- as.matrix(fit3b.reservations)
mcmc_areas(posterior,
           #regex_pars = c("^b_.*", "^sigma", "^Intercept", "^sd.*", "^r_.*"), # skip z_*
           regex_pars = "^[^z_.*]",
           prob = 0.8) +
  theme(plot.title.position = "plot") +
  labs(title = "NC Camping Reservations - mulit-level model 'fit3b.reservations'", 
       subtitle = "formula = n_reservations ~ 1 + year + (1 | site_type) + (1 | facility_name_original)")
```

<br>

```{r fig.height=10, fig.width=10, out.width="100%"}
# following examples at https://mc-stan.org/bayesplot/
posterior <- as.matrix(fit4b.reservations)
mcmc_areas(posterior,
           #regex_pars = c("^b_.*", "^sigma", "^Intercept", "^sd.*", "^r_.*"), # skip z_*
           regex_pars = "^[^z_.*]",
           prob = 0.8) +
  theme(plot.title.position = "plot") +
  labs(title = "NC Camping Reservations - mulit-level model 'fit4b.reservations'", 
       subtitle = "formula = n_reservations ~ 1 + year + (1 | site_type) + (1 | facility_name_original)")
```

<br>

```{r fig.height=20, fig.width=20}
fit3b.reservations %>%
  posterior_predict(draws = 500) %>%
  ppc_stat_grouped(y = df_facility_site_type$n_reservations,
                   group = df_facility_site_type$facility_name_original,
                   stat = "median") +
  labs(title = "Posterior Prediction of 'fit3b.reservations with group = df_facility_site_type$facility_name_original",
       subtitle = "Three actual n_reservations values are nearly out of the predicted posterior distributions of the medians")
```

<br>

fit4b predictions seem similar to fit3b

```{r fig.height=20, fig.width=20}
fit4b.reservations %>%
  posterior_predict(draws = 500) %>%
  ppc_stat_grouped(y = df_facility_site_type$n_reservations,
                   group = df_facility_site_type$facility_name_original,
                   stat = "median") +
  labs(title = "Posterior Prediction of 'fit4b.reservations with group = df_facility_site_type$facility_name_original",
       subtitle = "Three actual n_reservations values are nearly out of the predicted posterior distributions of the medians")
```

<br>

## PPC Intervals

```{r fig.height=9, fig.width=9, out.width="100%"}
ppc_intervals(
  y = df_facility_site_type$n_reservations,
  yrep = posterior_predict(fit3b.reservations),
  x = df_facility_site_type$year,
  prob = 0.5
) +
  labs(
    x = "Year",
    y = "n_reservations",
    title = "fit3b.reservations: 50% posterior predictive intervals \nvs observed n_reservations",
    subtitle = "add subtitle here"
  ) +
  panel_bg(fill = "gray95", color = NA) +
  grid_lines(color = "white")
```

<br>

```{r fig.height=9, fig.width=9, out.width="100%"}
ppc_intervals_grouped(
  y = df_facility_site_type$n_reservations,
  yrep = posterior_predict(fit3b.reservations),
  x = df_facility_site_type$year,
  group = df_facility_site_type$site_type,
  prob = 0.5
) +
  labs(
    x = "Year",
    y = "n_reservations",
    title = "fit3b.reservations: 50% posterior predictive intervals \nvs observed n_reservations",
    subtitle = "grouped by site_type"
  ) +
  panel_bg(fill = "gray95", color = NA) +
  grid_lines(color = "white")
```

<br>

fit4b has poorer estimates:

```{r fig.height=9, fig.width=9, out.width="100%"}
ppc_intervals_grouped(
  y = df_facility_site_type$n_reservations,
  yrep = posterior_predict(fit4b.reservations),
  x = df_facility_site_type$year,
  group = df_facility_site_type$site_type,
  prob = 0.5
) +
  labs(
    x = "Year",
    y = "n_reservations",
    title = "fit4b.reservations: 50% posterior predictive intervals \nvs observed n_reservations",
    subtitle = "grouped by site_type"
  ) +
  panel_bg(fill = "gray95", color = NA) +
  grid_lines(color = "white")
```

<br>

What if we group by facility instead? Still very poor.

```{r fig.height=26, fig.width=26, out.width="100%"}
ppc_intervals_grouped(
  y = df_facility_site_type$n_reservations,
  yrep = posterior_predict(fit4b.reservations),
  x = df_facility_site_type$year,
  group = df_facility_site_type$facility_name_original,
  prob = 0.5
) +
  labs(
    x = "Year",
    y = "n_reservations",
    title = "fit4b.reservations: 50% posterior predictive intervals \nvs observed n_reservations",
    subtitle = "grouped by facility_name_original"
  ) +
  panel_bg(fill = "gray95", color = NA) +
  grid_lines(color = "white")
```

<br>

What if we group by both facility and site_type? Nope: can't do both at once:

```{r fig.height=9, fig.width=9, eval=FALSE, echo=TRUE}
ppc_intervals_grouped(
  y = df_facility_site_type$n_reservations,
  yrep = posterior_predict(fit4b.reservations),
  x = df_facility_site_type$year,
  group = c(df_facility_site_type$site_type, df_facility_site_type$facility_first_word),
  prob = 0.5
) +
  labs(
    x = "Year",
    y = "n_reservations",
    title = "fit4b.reservations: 50% posterior predictive intervals \nvs observed n_reservations",
    subtitle = "grouped by facility_first_word"
  ) +
  panel_bg(fill = "gray95", color = NA) +
  grid_lines(color = "white")
```

```
Error: length(group) must be equal to length(y).
```

<br>

## PPC Density Overlay

```{r }
# per https://mc-stan.org/bayesplot/articles/graphical-ppcs.html

yrep <- posterior_predict(fit3b.reservations, draws = 500)
y <- fit3b.reservations$data$n_reservations
ppc_dens_overlay(y, yrep[1:50, ]) +
  labs(title = "fit3b.reservations")

yrep.4b <- posterior_predict(fit4b.reservations, draws = 500)
y.4b <- fit4b.reservations$data$n_reservations
ppc_dens_overlay(y.4b, yrep.4b[1:50, ]) +
  labs(title = "fit4b.reservations")

```

<br>

The posterior distribution $y$ definitely is not Gaussian.

<br>

# Thinking about priors

How to improve predictions?

* Set better priors to get posterior predictive check distribution closer to reality.
* What else?

```{r}
prior_summary(fit3b.reservations)
```

<br>

```{r}
prior_summary(fit4b.reservations)
options(width = 150)
```

<br>

## What is this posterior predictive distribution anyway?


### Is is like negative binomial?

Since n_reservations is an unbounded count, perhaps negative binomial? Nope.

```{r}
# with starter code from A Solomon Kurz's pa652 statistical analysis lecture materials
# at https://osf.io/3g8vf/
# 16. GLM: Unbounded counts with the negative binomial

# using MASS but calling function directly rather than loading MASS, since MASS::select() conflicts with dplyr::select()

n <- 10000
mu <- 5000

set.seed(1)

d <-
  tibble(phi = c(1, 5, 50, 500, 5000)) %>% 
  mutate(y = map(phi, ~ MASS::rnegbin(n = n, mu = mu, theta = .))) %>% 
  unnest(y) 

d %>% 
  ggplot(aes(x = y)) +
  geom_bar(fill = "chartreuse") +
  facet_wrap(~ phi, labeller = label_both, scales = "free")
```

<br>

### Is it like Poisson?

Or perhaps Poisson?  Nope.

```{r}

# with starter code from A Solomon Kurz's pa652 statistical analysis lecture materials
# at https://osf.io/3g8vf/
# 15. GLM: Unbounded counts with the Poisson

tibble(lambda = c(0.25, 0.5, 1, 2.5, 5, 10, 20, 40, 80)) %>% 
  mutate(count = map(lambda, ~ rpois(n = 10000, lambda = .))) %>% 
  unnest(count) %>% 
  
  ggplot(aes(x = count)) +
  geom_bar() +
  scale_y_continuous(NULL, breaks = NULL) +
  facet_wrap(~ lambda, scales = "free", labeller = label_both)
```

<br>

## Priors for our parameters

But none of the above are really helpful, since I need to model the parameters in the ***model***, not the ***posterior distribution***.

Let's consider fit4b.reservations, where `site_type` and `facility_name_original` are the groups in the hierarchical model.

Across all facilities, the site types' growth curves and their magnitudes vary considerably:

```{r fig.height=4, fig.width=10}
nc_camping_person_nights_and_revenue_site_type %>%
  group_by(year, site_type) %>%
  summarize(n_reservations = sum(n_reservations)) %>%
  ungroup() %>%
  mutate(site_type = fct_reorder(site_type, n_reservations),
         year = year + year_lower_bound - 1) %>% #view()
  ggplot(aes(x = year, y = n_reservations, fill = site_type)) +
  geom_area() +
  scale_x_continuous(labels = label_number(accuracy = 1, big.mark = ""),
                     breaks = (1:5) * 2 + 2008) +
  scale_y_continuous(labels = label_number_si()) +
  scale_fill_viridis_d(end = 0.92, direction = -1) +
  facet_grid(. ~ site_type) +
  theme(legend.position = "bottom") +
  labs(title = "NC camping n_reservations",
       subtitle = glue("{year_lower_bound}-{year_end}"),
       x = NULL,
       fill = "Site type")
```

<br>

Similarly, they vary widely across facilities:

```{r fig.height=30, fig.width=10}
nc_camping_person_nights_and_revenue_site_type %>%
  group_by(year, facility_name_original, site_type) %>%
  summarize(n_reservations = sum(n_reservations)) %>%
  ungroup() %>%
  mutate(facility_name_original = fct_reorder(facility_name_original, -n_reservations, sum),
         year = year + year_lower_bound - 1) %>% #view()
  ggplot(aes(x = year, y = n_reservations, fill = site_type)) +
  geom_area() +
  scale_x_continuous(labels = label_number(accuracy = 1, big.mark = ""),
                     breaks = (1:5) * 2 + 2008) +
  scale_y_continuous(labels = label_number_si()) +
  scale_fill_viridis_d(end = 0.92, direction = -1) +
  facet_wrap(. ~ facility_name_original, ncol = 4, scales = "free_y") +
  theme(legend.position = "top") +
  labs(title = "NC camping n_reservations",
       subtitle = glue("Y scale varies. {year_lower_bound}-{year_end}"),
       x = NULL,
       fill = "Site type")
```

<br>

Faceting by both in a grid:

```{r fig.height=60, fig.width=10}
nc_camping_person_nights_and_revenue_site_type %>%
  group_by(year, facility_name_original, site_type) %>%
  summarize(n_reservations = sum(n_reservations)) %>%
  ungroup() %>%
  mutate(facility_name_original = fct_reorder(facility_name_original, -n_reservations, sum),
         year = year + year_lower_bound - 1) %>% #view()
  ggplot(aes(x = year, y = n_reservations, fill = site_type)) +
  geom_area() +
  scale_x_continuous(labels = label_number(accuracy = 1, big.mark = ""),
                     breaks = (1:5) * 2 + 2008) +
  scale_y_continuous(labels = label_number_si()) +
  scale_fill_viridis_d(end = 0.92, direction = -1) +
  facet_grid(facility_name_original ~ site_type, scales = "free_y") + #, ncol = 4, scales = "free_y") +
  theme(legend.position = "top") +
  labs(title = "NC camping n_reservations",
       subtitle = glue("Y scale varies. {year_lower_bound}-{year_end}"),
       x = NULL,
       fill = "Site type")
```

<br>

### Person-nights and revenue_in_year

```{r fig.height=30, fig.width=10}
nc_camping_person_nights_and_revenue_site_type %>%
  group_by(year, facility_name_original, site_type) %>%
  summarize(person_nights = sum(person_nights)) %>%
  ungroup() %>%
  mutate(facility_name_original = fct_reorder(facility_name_original, -person_nights, sum),
         year = year + year_lower_bound - 1) %>% #view()
  ggplot(aes(x = year, y = person_nights, fill = site_type)) +
  geom_area() +
  scale_x_continuous(labels = label_number(accuracy = 1, big.mark = ""),
                     breaks = (1:5) * 2 + 2008) +
  scale_y_continuous(labels = label_number_si()) +
  scale_fill_viridis_d(end = 0.92, direction = -1) +
  facet_wrap(. ~ facility_name_original, ncol = 4, scales = "free_y") +
  theme(legend.position = "top") +
  labs(title = "NC camping person_nights",
       subtitle = glue("Y scale varies. {year_lower_bound}-{year_end}"),
       x = NULL,
       fill = "Site type")
```

<br>

```{r fig.height=30, fig.width=10}
nc_camping_person_nights_and_revenue_site_type %>%
  group_by(year, facility_name_original, site_type) %>%
  summarize(revenue_in_year = sum(revenue_in_year)) %>%
  ungroup() %>%
  mutate(facility_name_original = fct_reorder(facility_name_original, -revenue_in_year, sum),
         year = year + year_lower_bound - 1) %>% #view()
  ggplot(aes(x = year, y = revenue_in_year, fill = site_type)) +
  geom_area() +
  scale_x_continuous(labels = label_number(accuracy = 1, big.mark = ""),
                     breaks = (1:5) * 2 + 2008) +
  #scale_y_continuous(labels = label_number_si(), prefix = "$") +
  scale_y_continuous(labels = label_dollar(scale = .001, suffix = "K")) +
  scale_fill_viridis_d(end = 0.92, direction = -1) +
  facet_wrap(. ~ facility_name_original, ncol = 4, scales = "free_y") +
  theme(legend.position = "top") +
  labs(title = "NC camping revenue_in_year",
       subtitle = glue("Y scale varies. {year_lower_bound}-{year_end}"),
       x = NULL,
       fill = "Site type")
```

<br>
<br>